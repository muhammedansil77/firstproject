<main class="min-h-screen bg-slate-950 text-white">

  <div class="max-w-7xl mx-auto px-10 py-20">
    <div class="flex flex-col lg:flex-row gap-16">

      <!-- Sidebar Filters -->
      <aside class="lg:w-72">
        <div class="sticky top-24">
          <!-- Filter Header -->
          <div class="flex justify-between items-center mb-8">
            <h3 class="text-sm font-semibold tracking-[0.15em] text-white">FILTERS</h3>
            <button onclick="clearAllFilters()" class="text-xs tracking-[0.1em] text-gray-500 hover:text-amber-400 transition duration-300 uppercase">Clear All</button>
          </div>

          <!-- Category Filter -->
        <!-- Category Filter -->
<div class="mb-10 pb-8 border-b border-amber-500/10">
  <label class="text-xs font-semibold tracking-[0.15em] text-gray-400 mb-4 block uppercase">Category</label>
  <select id="category-select" onchange="applyFilter()" 
          class="w-full px-4 py-3 rounded-lg bg-slate-900/50 border border-amber-500/20 text-sm text-white placeholder-gray-600 hover:border-amber-400/50 focus:border-amber-400 focus:outline-none transition duration-300 backdrop-blur">
    <option value="all">All Categories</option>
    <% (categories || []).forEach(cat => { %>
      <option value="<%= cat._id %>" 
              <%= query.category === String(cat._id) ? 'selected' : '' %>>
        <%= cat.name %>
      </option>
    <% }) %>
  </select>
</div>

          <!-- Price Range -->
          <div class="mb-10 pb-8 border-b border-amber-500/10">
            <label class="text-xs font-semibold tracking-[0.15em] text-gray-400 mb-4 block uppercase">Price Range</label>
            <div class="space-y-3 mb-5">
              <input type="number" id="price-from" placeholder="₹ Min" value="<%= query.min || '' %>"
                     class="w-full px-4 py-3 bg-slate-900/50 border border-amber-500/20 rounded-lg text-sm text-white placeholder-gray-600 hover:border-amber-400/50 focus:border-amber-400 focus:outline-none transition duration-300 backdrop-blur"
                     min="0" step="100" />
              <input type="number" id="price-to" placeholder="₹ Max" value="<%= query.max || '' %>"
                     class="w-full px-4 py-3 bg-slate-900/50 border border-amber-500/20 rounded-lg text-sm text-white placeholder-gray-600 hover:border-amber-400/50 focus:border-amber-400 focus:outline-none transition duration-300 backdrop-blur"
                     min="0" step="100" />
            </div>
            <button onclick="applyFilter()" class="w-full bg-gradient-to-r from-amber-400 to-amber-500 text-black font-medium py-3 rounded-lg text-sm tracking-widest hover:shadow-xl hover:shadow-amber-400/30 transition duration-300 uppercase">
              Apply
            </button>
          </div>

          <!-- Quick Ranges -->
          <div>
            <label class="text-xs font-semibold tracking-[0.15em] text-gray-400 mb-4 block uppercase">Quick Selection</label>
            <div class="space-y-2">
              <button onclick="setPrice(0,999)" class="w-full text-left py-3 px-4 bg-slate-900/30 rounded-lg border border-amber-500/10 hover:border-amber-400 hover:bg-amber-400/5 text-sm text-gray-300 hover:text-amber-400 transition duration-300">
                Under ₹999
              </button>
              <button onclick="setPrice(1000,4999)" class="w-full text-left py-3 px-4 bg-slate-900/30 rounded-lg border border-amber-500/10 hover:border-amber-400 hover:bg-amber-400/5 text-sm text-gray-300 hover:text-amber-400 transition duration-300">
                ₹1,000 – ₹4,999
              </button>
              <button onclick="setPrice(5000,null)" class="w-full text-left py-3 px-4 bg-slate-900/30 rounded-lg border border-amber-500/10 hover:border-amber-400 hover:bg-amber-400/5 text-sm text-gray-300 hover:text-amber-400 transition duration-300">
                ₹5,000+
              </button>
            </div>
          </div>
        </div>
      </aside>

      <!-- Products Section -->
      <section class="flex-1">

        <!-- Section Header -->
        <div class="mb-12">
          <h1 class="text-5xl lg:text-6xl font-light tracking-tight mb-3">Collection</h1>
          <p class="text-gray-400 text-sm tracking-[0.1em] uppercase">Premium Timepieces & Luxury</p>
        </div>

        <!-- Sort Controls -->
        <div class="flex justify-between items-center mb-12 pb-8 border-b border-amber-500/10">
          <div class="flex flex-col gap-1">
            <p class="text-xs text-gray-500 tracking-widest uppercase">Sort By</p>
          </div>

          <select id="sort-by" onchange="applyFilter()" 
        class="px-5 py-3 bg-slate-900/50 border border-amber-500/20 rounded-lg text-sm text-white hover:border-amber-400/50 focus:border-amber-400 focus:outline-none transition duration-300 cursor-pointer backdrop-blur">
  <option value="" <%= !query.sort || query.sort === '' ? 'selected' : '' %>>Best Match</option>
  <option value="latest" <%= query.sort === 'latest' ? 'selected' : '' %>>New Arrivals</option>
  <option value="price-asc" <%= query.sort === 'price-asc' ? 'selected' : '' %>>Price: Low to High</option>
  <option value="price-desc" <%= query.sort === 'price-desc' ? 'selected' : '' %>>Price: High to Low</option>
  <option value="a-z" <%= query.sort === 'a-z' ? 'selected' : '' %>>Name: A to Z</option>
  <option value="z-a" <%= query.sort === 'z-a' ? 'selected' : '' %>>Name: Z to A</option>
</select>
        </div>

        <!-- Active Filters Tags -->
       <!-- Active Filters Tags -->
<% if (query.search || query.min || query.max || query.sort || query.category) { %>
<div class="flex flex-wrap gap-2 mb-10">
  <% if (query.category && categories) { 
    const activeCat = categories.find(c => String(c._id) === query.category);
  %>
    <span class="px-4 py-2 bg-amber-400/10 rounded-full text-xs tracking-widest flex items-center gap-2 border border-amber-500/30">
      Category: <%= activeCat ? activeCat.name : query.category %>
      <button onclick="removeFilter('category')" class="text-gray-500 hover:text-amber-400 transition">✕</button>
    </span>
  <% } %>
  
  <% if (query.search) { %>
    <span class="px-4 py-2 bg-amber-400/10 rounded-full text-xs tracking-widest flex items-center gap-2 border border-amber-500/30">
      Search: <%= query.search %> 
      <button onclick="removeFilter('search')" class="text-gray-500 hover:text-amber-400 transition">✕</button>
    </span>
  <% } %>
  
  <% if (query.min || query.max) { %>
    <span class="px-4 py-2 bg-amber-400/10 rounded-full text-xs tracking-widest flex items-center gap-2 border border-amber-500/30">
      Price: ₹<%= query.min || '0' %> – ₹<%= query.max || '∞' %>
      <button onclick="removePriceFilter()" class="text-gray-500 hover:text-amber-400 transition">✕</button>
    </span>
  <% } %>
  
<% if (query.sort && query.sort !== '') { 
  let sortName = '';
  switch(query.sort) {
    case 'latest': sortName = 'New Arrivals'; break;
    case 'price-asc': sortName = 'Price: Low to High'; break;
    case 'price-desc': sortName = 'Price: High to Low'; break;
    case 'a-z': sortName = 'Name: A to Z'; break;
    case 'z-a': sortName = 'Name: Z to A'; break;
    default: sortName = 'Best Match';
  }
%>
  <span class="px-4 py-2 bg-amber-400/10 rounded-full text-xs tracking-widest flex items-center gap-2 border border-amber-500/30">
    Sort: <%= sortName %>
    <button onclick="removeFilter('sort')" class="text-gray-500 hover:text-amber-400 transition">✕</button>
  </span>
<% } %>
</div>
<% } %>

        <!-- Image Helper -->
        <% 
          function normImg(src) {
            if (!src) return '/uploads/placeholder.png';
            const s = String(src).trim();
            if (!s) return '/uploads/placeholder.png';
            return s.startsWith('/') ? s : '/' + s;
          }
        %>

        <!-- Product Grid -->
        <% if (products && products.length > 0) { %>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8 mb-16">
          <% products.forEach(product => { 
               const imgVal = (Array.isArray(product.images) && product.images.find(x => x)) || null;
               const mainImg = normImg(imgVal);
               const priceNum = (product.price !== undefined && product.price !== null)
                 ? Number(product.price)
                 : (product.minPrice !== undefined && product.minPrice !== null)
                   ? Number(product.minPrice)
                   : null;
          %>

          <a href="/user/shop/<%= product._id %>" class="group block">
            <div class="relative bg-slate-900/40 backdrop-blur rounded-2xl overflow-hidden border border-amber-500/10 
                        hover:border-amber-400/30 shadow-lg hover:shadow-2xl hover:shadow-amber-400/10
                        transition-all duration-500">
              
              <!-- Image Container -->
              <div class="relative w-full aspect-square overflow-hidden bg-slate-900">
                <img src="<%= mainImg %>" alt="<%= product.name %>" 
                     class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110"
                     loading="lazy"
                     onerror="this.onerror=null;this.src='/uploads/placeholder.png';this.style.opacity=0.5;" />
                
                <!-- Overlay -->
                <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                
                <!-- View Button Overlay -->
                <div class="absolute inset-0 flex items-end justify-center pb-6 opacity-0 group-hover:opacity-100 transition-opacity duration-500">
                  <span class="px-6 py-2 bg-gradient-to-r from-amber-400 to-amber-500 text-black text-xs font-semibold tracking-widest rounded-full uppercase shadow-lg">
                    View Details
                  </span>
                </div>
              </div>

              <!-- Product Info -->
              <div class="p-6">
                <h3 class="text-base font-medium text-white mb-2 line-clamp-2 group-hover:text-amber-400 transition duration-300">
                  <%= product.name %>
                </h3>
                
                <p class="text-xs text-gray-500 mb-4 tracking-widest">LUXURY COLLECTION</p>

                <!-- Price -->
                <div class="flex items-baseline justify-between">
                  <div class="flex items-baseline gap-1">
                    <span class="text-2xl font-light text-amber-400">
                      <% if (priceNum !== null && Number.isFinite(priceNum)) { %>
                        ₹<%= priceNum.toLocaleString('en-IN') %>
                      <% } else { %>
                        —
                      <% } %>
                    </span>
                    <% if (priceNum !== null) { %>
                      <span class="text-xs text-gray-500 ml-2">+GST</span>
                    <% } %>
                  </div>
                </div>
              </div>
            </div>
          </a>

          <% }) %>
        </div>

        <% } else { %>
        <!-- Empty State -->
        <div class="flex flex-col items-center justify-center py-32">
          <svg class="w-16 h-16 text-gray-700 mb-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
          </svg>
          <h2 class="text-2xl font-light text-gray-400 mb-2">No Products Found</h2>
          <p class="text-gray-600 text-sm mb-8 text-center max-w-md">Try adjusting your filters to discover our premium collection.</p>
          <button onclick="clearAllFilters()" class="px-8 py-3 bg-gradient-to-r from-amber-400 to-amber-500 text-black font-medium text-sm tracking-widest rounded-lg hover:shadow-xl hover:shadow-amber-400/20 transition duration-300 uppercase">
            Reset Filters
          </button>
        </div>
        <% } %>

        <!-- Pagination -->
        <% if (pagination && pagination.totalPages > 1) { %>
        <div class="flex justify-center gap-2 mt-20 pt-12 border-t border-amber-500/10">
          <% for(let i = 1; i <= pagination.totalPages; i++) { %>
            <button onclick="changePage(<%= i %>)"
                    class="w-10 h-10 rounded-full border transition text-sm font-medium
                    <%= i === pagination.currentPage 
                      ? 'bg-amber-400 text-black border-amber-400' 
                      : 'border-amber-500/20 text-gray-400 hover:border-amber-400 hover:text-amber-400' %>">
              <%= i %>
            </button>
          <% } %>
        </div>
        <% } %>

      </section>
    </div>
  </div>

</main>

<pre id="debug-products" style="display:none"><%= JSON.stringify((products||[]).slice(0,8), null, 2) %></pre>
<script>
  try {
    const dbg = document.getElementById('debug-products');
    if (dbg) console.log('SHOP debug products sample:', JSON.parse(dbg.textContent || '[]'));
  } catch(e) { console.warn('debug print failed', e); }
</script>