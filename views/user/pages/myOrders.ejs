<!-- views/user/pages/myOrders.ejs -->
<main class="min-h-screen bg-gradient-to-br from-[#0a0a0a] via-[#0f0f0f] to-[#1a1a1a] text-white antialiased">
  <!-- Breadcrumbs -->
  <div class="w-full bg-gradient-to-r from-[#0b0b0b] to-[#151515] border-y border-[#2a2a2a]">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <nav class="py-4" aria-label="Breadcrumb">
        <ol class="flex items-center space-x-2 text-sm">
          <li>
            <a href="/user" class="text-gray-400 hover:text-[#d4af37] transition-colors flex items-center gap-1">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
              </svg>
              Home
            </a>
          </li>
          <li class="flex items-center">
            <svg class="w-4 h-4 mx-1 text-gray-600" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
            </svg>
          </li>
          <li>
            <a href="/user/shop" class="text-gray-400 hover:text-[#d4af37] transition-colors">
              Dashboard
            </a>
          </li>
          <li class="flex items-center">
            <svg class="w-4 h-4 mx-1 text-gray-600" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
            </svg>
          </li>
          <li>
            <span class="text-[#d4af37] font-medium" aria-current="page">
              My Orders
            </span>
          </li>
        </ol>
      </nav>
    </div>
  </div>

  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header -->
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-white">My Orders</h1>
      <p class="text-gray-400 mt-2">Track and manage all your purchases</p>
    </div>

    <!-- Stats and Filters -->
    <div class="mb-8">
      <!-- Stats Cards -->
      <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
        <div class="bg-gradient-to-br from-[#0b0b0b] to-[#151515] rounded-xl border border-[#2a2a2a] p-4">
          <p class="text-sm text-gray-400">Total Orders</p>
          <p class="text-2xl font-bold text-white mt-1"><%= totalOrders || 0 %></p>
        </div>
        <div class="bg-gradient-to-br from-[#0b0b0b] to-[#151515] rounded-xl border border-[#2a2a2a] p-4">
          <p class="text-sm text-gray-400">Active</p>
          <p class="text-2xl font-bold text-[#d4af37] mt-1"><%= statusCounts.Confirmed + statusCounts.Shipped || 0 %></p>
        </div>
        <div class="bg-gradient-to-br from-[#0b0b0b] to-[#151515] rounded-xl border border-[#2a2a2a] p-4">
          <p class="text-sm text-gray-400">Delivered</p>
          <p class="text-2xl font-bold text-green-400 mt-1"><%= statusCounts.Delivered || 0 %></p>
        </div>
        <div class="bg-gradient-to-br from-[#0b0b0b] to-[#151515] rounded-xl border border-[#2a2a2a] p-4">
          <p class="text-sm text-gray-400">Pending</p>
          <p class="text-2xl font-bold text-yellow-400 mt-1"><%= statusCounts.Placed || 0 %></p>
        </div>
        <div class="bg-gradient-to-br from-[#0b0b0b] to-[#151515] rounded-xl border border-[#2a2a2a] p-4">
          <p class="text-sm text-gray-400">Cancelled</p>
          <p class="text-2xl font-bold text-red-400 mt-1"><%= statusCounts.Cancelled || 0 %></p>
        </div>
      </div>

      <!-- Filter Tabs -->
      <div class="flex items-center justify-between mb-6">
        <div class="flex flex-wrap gap-2">
          <a href="/orders" 
             class="px-4 py-2 rounded-lg border <%= !statusFilter ? 'bg-gradient-to-r from-[#d4af37] to-[#b8941f] border-transparent text-black font-semibold' : 'border-[#2a2a2a] text-gray-300 hover:border-[#d4af37]/30' %> transition-all">
            All
          </a>
          <a href="/orders?status=Placed" 
             class="px-4 py-2 rounded-lg border <%= statusFilter === 'Placed' ? 'border-blue-400 text-blue-300' : 'border-[#2a2a2a] text-gray-300 hover:border-[#d4af37]/30' %> transition-all">
            Placed
          </a>
          <a href="/orders?status=Confirmed" 
             class="px-4 py-2 rounded-lg border <%= statusFilter === 'Confirmed' ? 'border-yellow-400 text-yellow-300' : 'border-[#2a2a2a] text-gray-300 hover:border-[#d4af37]/30' %> transition-all">
            Confirmed
          </a>
          <a href="/orders?status=Shipped" 
             class="px-4 py-2 rounded-lg border <%= statusFilter === 'Shipped' ? 'border-purple-400 text-purple-300' : 'border-[#2a2a2a] text-gray-300 hover:border-[#d4af37]/30' %> transition-all">
            Shipped
          </a>
          <a href="/orders?status=Delivered" 
             class="px-4 py-2 rounded-lg border <%= statusFilter === 'Delivered' ? 'border-green-400 text-green-300' : 'border-[#2a2a2a] text-gray-300 hover:border-[#d4af37]/30' %> transition-all">
            Delivered
          </a>
          <a href="/orders?status=Cancelled" 
             class="px-4 py-2 rounded-lg border <%= statusFilter === 'Cancelled' ? 'border-red-400 text-red-300' : 'border-[#2a2a2a] text-gray-300 hover:border-[#d4af37]/30' %> transition-all">
            Cancelled
          </a>
        </div>

        <div class="flex items-center gap-3">
          <div class="relative">
            <input 
              type="text" 
              id="searchOrders" 
              placeholder="Search orders..." 
              class="pl-10 pr-4 py-2 bg-[#0b0b0b]/50 border border-[#2a2a2a] rounded-lg focus:border-[#d4af37] focus:outline-none w-full md:w-64 text-white placeholder-gray-500"
            >
            <svg class="w-5 h-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
            </svg>
          </div>
          
          <div class="relative">
            <select 
              id="sortOrders" 
              class="appearance-none bg-[#0b0b0b]/50 border border-[#2a2a2a] rounded-lg px-4 py-2 pr-10 focus:border-[#d4af37] focus:outline-none text-white"
            >
                <option value="newest" <%= sortBy === 'newest' ? 'selected' : '' %>>Newest</option>
  <option value="oldest" <%= sortBy === 'oldest' ? 'selected' : '' %>>Oldest</option>
  <option value="highest" <%= sortBy === 'highest' ? 'selected' : '' %>>Highest</option>
  <option value="lowest" <%= sortBy === 'lowest' ? 'selected' : '' %>>Lowest</option>
            </select>
            <svg class="w-5 h-5 absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
            </svg>
          </div>
        </div>
      </div>
    </div>

   <!-- Products List (Grouped UI Only) -->
<div class="space-y-6">

<%
  /* ===============================
     UI-ONLY GROUPING LOGIC
     Group orders by same checkout minute
  =============================== */
  const groupedOrders = {};

  if (orders && orders.length > 0) {
    orders.forEach(order => {
      const key = new Date(order.createdAt).toISOString().slice(0, 16); // same minute

      if (!groupedOrders[key]) {
        groupedOrders[key] = {
          createdAt: order.createdAt,
          orders: [],
          totalAmount: 0
        };
      }

      groupedOrders[key].orders.push(order);
      groupedOrders[key].totalAmount += order.finalAmount || 0;
    });
  }

  const groupedOrderList = Object.values(groupedOrders);
%>

<% if (groupedOrderList.length > 0) { %>

  <% groupedOrderList.forEach(group => { %>

  <!-- ORDER CONTAINER -->
  <div class="bg-gradient-to-br from-[#0b0b0b] to-[#151515] rounded-2xl border border-[#2a2a2a] overflow-hidden">

    <!-- ORDER HEADER -->
    <div class="p-6 border-b border-[#2a2a2a] bg-[#0f0f0f]">
      <div class="flex items-center gap-4">
        <div class="w-12 h-12 rounded-xl bg-[#1a1a1a] flex items-center justify-center">
          <svg class="w-6 h-6 text-[#d4af37]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"/>
          </svg>
        </div>

        <div>
          <h3 class="text-lg font-bold text-white">
            Order • <%= new Date(group.createdAt).toLocaleDateString('en-IN', {
              day: 'numeric', month: 'short', year: 'numeric'
            }) %>
          </h3>

          <p class="text-sm text-gray-400">
            <%= group.orders.reduce((sum, o) => sum + (o.items?.length || 0), 0) %> items •
            Total ₹<%= group.totalAmount.toLocaleString('en-IN', { minimumFractionDigits: 2 }) %>
          </p>
        </div>
      </div>
    </div>

    <!-- PRODUCTS -->
    <div class="divide-y divide-[#2a2a2a]">

      <% group.orders.forEach(order => { %>
        <% if (order.items && order.items.length > 0) { %>
          <% order.items.forEach(item => { %>

          <div class="p-6 hover:bg-[#0f0f0f]/50 transition-colors">
            <div class="flex flex-col md:flex-row gap-6">

              <!-- IMAGE -->
              <!-- IMAGE (FROM VARIANT) -->
<div class="w-32 h-32 rounded-xl overflow-hidden bg-[#1a1a1a] flex items-center justify-center">
  <%
    const image =
      item.variant?.images && item.variant.images.length > 0
        ? item.variant.images[0]
        : '/uploads/placeholder.png';
  %>

  <img
    src="<%= image.startsWith('http') || image.startsWith('/') ? image : '/' + image %>"
    alt="<%= item.product?.name || 'Product' %>"
    class="w-full h-full object-cover"
    onerror="this.onerror=null; this.src='/uploads/placeholder.png';"
  >
</div>


              <!-- INFO -->
              <div class="flex-1">
                <h4 class="font-bold text-white text-lg">
                  <%= item.product?.name || 'Product' %>
                </h4>

                <% if (item.variant) { %>
                  <p class="text-sm text-gray-400">
                    Color: <%= item.variant.color || '-' %> |
                    Size: <%= item.variant.size || '-' %>
                  </p>
                <% } %>

                <p class="text-sm text-gray-400">
                  Quantity: <%= item.quantity %>
                </p>

                <p class="mt-2 text-[#d4af37] font-bold">
                  ₹<%= item.total.toLocaleString('en-IN') %>
                </p>
              </div>

              <!-- ACTION -->
              <div>
                <a href="/orders/<%= order._id %>"
                   class="px-4 py-2 bg-gradient-to-r from-[#d4af37] to-[#b8941f]
                          text-black rounded-lg font-semibold">
                  View Order Details
                </a>
              </div>

            </div>
          </div>

          <% }) %>
        <% } %>
      <% }) %>

    </div>

  <!-- FOOTER -->
<div class="p-6 border-t border-[#2a2a2a] bg-[#0f0f0f] flex justify-between items-center">

  <span class="text-xs text-gray-500 italic">
    Grouped view (UI only)
  </span>

<%
  const cancellableOrders = group.orders.filter(o =>
    o.orderStatus === 'Placed' || o.orderStatus === 'Confirmed'
  );
%>

<button
  <% if (cancellableOrders.length === 0) { %> disabled <% } %>
  onclick='cancelEntireGroup(<%- JSON.stringify(cancellableOrders.map(o => o._id)) %>)'
  class="px-5 py-2 rounded-lg font-semibold transition-all
    <%= cancellableOrders.length === 0
      ? 'bg-gray-700 text-gray-400 cursor-not-allowed'
      : 'border border-red-500/40 text-red-400 hover:bg-red-500/10'
    %>"
>
  Cancel Entire Order
</button>

</div>


  </div>

  <% }) %>

<% } else { %>

  <!-- EMPTY STATE -->
  <div class="bg-gradient-to-br from-[#0b0b0b] to-[#151515]
              rounded-2xl border border-[#2a2a2a] p-12 text-center">
    <h3 class="text-2xl font-bold text-white mb-3">No orders yet</h3>
    <p class="text-gray-400 mb-6">Start shopping to see your orders here</p>
    <a href="/shop"
       class="px-6 py-3 bg-gradient-to-r from-[#d4af37] to-[#b8941f]
              text-black font-bold rounded-lg">
      Start Shopping
    </a>
  </div>

<% } %>

</div>

    <!-- Pagination -->
    <% if (totalPages > 1) { %>
    <div class="mt-12">
      <div class="flex justify-center">
        <nav class="flex items-center gap-2">
          <% if (page > 1) { %>
          <a 
            href="/orders?page=<%= page - 1 %><%= statusFilter ? '&status=' + statusFilter : '' %>" 
            class="w-10 h-10 flex items-center justify-center border border-[#2a2a2a] rounded-lg hover:border-[#d4af37]/30 hover:bg-[#1a1a1a] transition-colors"
          >
            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
            </svg>
          </a>
          <% } %>
          
          <% for (let i = 1; i <= totalPages; i++) { %>
            <% if (i === 1 || i === totalPages || (i >= page - 2 && i <= page + 2)) { %>
            <a 
              href="/orders?page=<%= i %><%= statusFilter ? '&status=' + statusFilter : '' %>" 
              class="w-10 h-10 flex items-center justify-center border <%= page === i ? 'border-[#d4af37] bg-gradient-to-r from-[#d4af37] to-[#b8941f] text-black font-bold' : 'border-[#2a2a2a] text-gray-300 hover:border-[#d4af37]/30' %> rounded-lg transition-all"
            >
              <%= i %>
            </a>
            <% } else if (i === page - 3 || i === page + 3) { %>
            <span class="w-10 h-10 flex items-center justify-center text-gray-600">...</span>
            <% } %>
          <% } %>
          
          <% if (page < totalPages) { %>
          <a 
            href="/orders?page=<%= page + 1 %><%= statusFilter ? '&status=' + statusFilter : '' %>" 
            class="w-10 h-10 flex items-center justify-center border border-[#2a2a2a] rounded-lg hover:border-[#d4af37]/30 hover:bg-[#1a1a1a] transition-colors"
          >
            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
          </a>
          <% } %>
        </nav>
      </div>
    </div>
    <% } %>
  </div>
</main>

<script>
function cancelOrder(orderId) {
  if (confirm('Are you sure you want to cancel this entire order?')) {
    fetch(`/orders/${orderId}/cancel`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        reason: 'User requested cancellation',
        reasonCode: 'changed_mind'
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert('Order cancelled successfully!');
        window.location.reload();
      } else {
        alert('Failed to cancel order: ' + data.message);
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('An error occurred while cancelling the order.');
    });
  }
}

function requestReturnItem(orderId, itemId) {
  if (confirm('Are you sure you want to request a return/exchange for this item?')) {
    alert('Return feature coming soon!');
    // Implement API call for item-specific return
  }
}
</script>