<!-- views/user/pages/checkout.ejs -->
<main class="min-h-screen bg-gradient-to-br from-[#0a0a0a] via-[#0f0f0f] to-[#1a1a1a] text-white antialiased">
  <!-- Breadcrumbs -->
  <div class="w-full bg-gradient-to-r from-[#0b0b0b] to-[#151515] border-y border-[#2a2a2a]">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <nav class="py-4" aria-label="Breadcrumb">
        <ol class="flex items-center space-x-2 text-sm">
          <li>
            <a href="user/shop" class="text-gray-400 hover:text-[#d4af37] transition-colors flex items-center gap-1">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
              </svg>
              product
            </a>
          </li>
          <li class="flex items-center">
            <svg class="w-4 h-4 mx-1 text-gray-600" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
            </svg>
          </li>
          <li>
            <a href="/user/cart" class="text-gray-400 hover:text-[#d4af37] transition-colors">
              Cart
            </a>
          </li>
          <li class="flex items-center">
            <svg class="w-4 h-4 mx-1 text-gray-600" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
            </svg>
          </li>
          <li>
            <span class="text-[#d4af37] font-medium" aria-current="page">
              Checkout
            </span>
          </li>
        </ol>
      </nav>
    </div>
  </div>

  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl font-bold text-white mb-2">Checkout</h1>
    <p class="text-gray-400 mb-8">Complete your purchase with secure checkout</p>
    
    <div class="flex flex-col lg:flex-row gap-8">
      <!-- Left Column - User Information -->
      <div class="lg:w-2/3 space-y-8">
        <!-- Address Section -->
        <div class="bg-gradient-to-br from-[#0b0b0b] to-[#151515] rounded-2xl border border-[#2a2a2a] p-6">
          <div class="flex justify-between items-center mb-6 pb-4 border-b border-[#2a2a2a]">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 rounded-lg bg-[#d4af37]/10 flex items-center justify-center">
                <svg class="w-5 h-5 text-[#d4af37]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
              </div>
              <h2 class="text-xl font-bold text-white">Delivery Address</h2>
            </div>
            <!-- id="addAddressBtn" -->
           <a 
  href="/user/address" 
  
  class="flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-[#d4af37] to-[#b8941f] text-black font-semibold rounded-lg hover:shadow-lg hover:shadow-[#d4af37]/20 transition-all"
>
  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
  </svg>
  Add New Address
</a>

          </div>
          
          <div class="space-y-4" id="addressesContainer">
            <% if (addresses && addresses.length > 0) { %>
              <% addresses.forEach((address, index) => { %>
             <div 
  class="address-card border-2 rounded-xl p-5 cursor-pointer transition-all
  <%= address.isDefault ? 'border-[#d4af37] bg-[#d4af37]/5 selected' : 'border-[#2a2a2a]' %>"
  data-address-id="<%= address._id %>"
>

                  <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center gap-3">
                      <input 
                        type="radio" 
                        name="deliveryAddress" 
                        id="address<%= address._id %>" 
                        value="<%= address._id %>"
                        class="w-5 h-5 text-[#d4af37] cursor-pointer"
                        <%= address.isDefault ? 'checked' : '' %>
                      >
                      <label 
                        for="address<%= address._id %>" 
                        class="font-bold text-white cursor-pointer flex items-center gap-2"
                      >
                        <span class="capitalize"><%= address.addressType || 'Address' %></span>
                        <% if (address.isDefault) { %>
                          <span class="px-2 py-1 bg-[#d4af37] text-black text-xs font-bold rounded-full">Default</span>
                        <% } %>
                      </label>
                    </div>
                    <div class="flex gap-2">
                <a href="/user/address?edit=<%= address._id %>" class="edit-btn">
  Edit
</a>



                      <% if (!address.isDefault) { %>
                      <button 
                        class="delete-address-btn flex items-center gap-2 px-3 py-1.5 rounded-lg border border-red-500/30 text-red-400 hover:bg-red-500/10 transition-all"
                        data-address-id="<%= address._id %>"
                      >
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                        </svg>
                      </button>
                      <% } %>
                    </div>
                  </div>
                  <div class="space-y-2 text-gray-300 ml-8">
                    <p class="font-semibold text-white"><%= address.fullName %></p>
                    <p><%= address.phone %></p>
                    <p><%= address.addressLine1 %></p>
                    <% if (address.addressLine2) { %>
                      <p><%= address.addressLine2 %></p>
                    <% } %>
                    <p><%= address.city %>, <%= address.state %> <%= address.postalCode %></p>
                    <p class="text-gray-400"><%= address.country %></p>
                  </div>
                </div>
              <% }); %>
            <% } else { %>
              <div class="text-center py-12">
                <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-[#d4af37]/10 flex items-center justify-center">
                  <svg class="w-8 h-8 text-[#d4af37]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                  </svg>
                </div>
                <h3 class="text-lg font-bold text-white mb-2">No Addresses Yet</h3>
                <p class="text-gray-400 mb-6">Add your delivery address to continue</p>
                <button 
                  type="button" 
                  id="addFirstAddressBtn"
                  class="px-6 py-3 bg-gradient-to-r from-[#d4af37] to-[#b8941f] text-black font-bold rounded-lg hover:shadow-lg hover:shadow-[#d4af37]/20 transition-all"
                >
                  Add Your First Address
                </button>
              </div>
            <% } %>
          </div>
        </div>

        <!-- Products in Checkout Section -->
        <div class="bg-gradient-to-br from-[#0b0b0b] to-[#151515] rounded-2xl border border-[#2a2a2a] p-6">
          <div class="mb-6 pb-4 border-b border-[#2a2a2a]">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 rounded-lg bg-[#d4af37]/10 flex items-center justify-center">
                <svg class="w-5 h-5 text-[#d4af37]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"/>
                </svg>
              </div>
              <h2 class="text-xl font-bold text-white">Order Items</h2>
            </div>
          </div>
          
          <div class="space-y-4">
            <% if (cartItems && cartItems.length > 0) { %>
              <% cartItems.forEach((item, index) => { %>
                <div class="flex items-start gap-4 p-4 bg-[#0b0b0b]/50 border border-[#2a2a2a] rounded-xl hover:border-[#d4af37]/30 transition-all">
                  <!-- Product Image -->
                  <div class="w-20 h-20 flex-shrink-0">
                    <img 
                      src="<%= (item.variant && item.variant.images && item.variant.images[0]) ? item.variant.images[0] : '/images/placeholder.jpg' %>" 
                      alt="<%= item.product ? item.product.name : 'Product' %>"
                      class="w-full h-full object-cover rounded-lg"
                      onerror="this.onerror=null; this.src='/images/placeholder.jpg';"
                    >
                  </div>
                  
                  <!-- Product Details -->
                  <div class="flex-grow">
                    <h3 class="font-medium text-white">
                      <%= item.product ? item.product.name : 'Product' %>
                    </h3>
                    
                    <!-- Variant Details -->
                    <% if (item.variant) { %>
                      <p class="text-sm text-gray-400 mt-1">
                        <% if (item.variant.color && item.variant.color !== 'null') { %>
                          Color: <%= item.variant.color %>
                        <% } %>
                        <% if (item.variant.size && item.variant.size !== 'null') { %>
                          <% if (item.variant.color && item.variant.color !== 'null') { %> | <% } %>
                          Size: <%= item.variant.size %>
                        <% } %>
                      </p>
                    <% } %>
                    
                    <!-- Price and Quantity -->
 <!-- Price and Quantity -->
<div class="flex justify-between items-center mt-2">
  <div class="flex flex-col">
    <span class="text-sm font-semibold text-[#d4af37]">
      <% if (item.price !== undefined && item.price !== null) { %>
        ‚Çπ<%= item.price.toFixed(2) %> each
      <% } else { %>
        ‚Çπ<%= item.basePrice.toFixed(2) %> each
      <% } %>
    </span>
    
    <% if (item.offer) { %>
      <span class="text-xs text-gray-400 line-through">
        ‚Çπ<%= item.basePrice.toFixed(2) %>
      </span>
      <span class="text-xs text-green-400">
        <%= item.offer.discountValue %>
        <%= item.offer.discountType === 'percentage' ? '% OFF' : '‚Çπ OFF' %>
      </span>
    <% } %>
  </div>

  <span class="text-gray-400">Qty: <%= item.quantity %></span>

  <span class="font-semibold text-[#d4af37]">
    <% if (item.itemTotal !== undefined && item.itemTotal !== null) { %>
      ‚Çπ<%= item.itemTotal.toFixed(2) %>
    <% } else { %>
      ‚Çπ<%= (item.price * item.quantity).toFixed(2) %>
    <% } %>
  </span>
</div>
                    
                    <!-- Stock Warning -->
                    <% if (item.variant && item.variant.stock && item.variant.stock < 10) { %>
                      <p class="text-sm text-red-400 mt-1">
                        Only <%= item.variant.stock %> left in stock
                      </p>
                    <% } %>
                  </div>
                </div>
              <% }); %>
            <% } else { %>
              <div class="text-center py-12">
                <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-[#d4af37]/10 flex items-center justify-center">
                  <svg class="w-8 h-8 text-[#d4af37]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"/>
                  </svg>
                </div>
                <h3 class="text-lg font-bold text-white mb-2">Your Cart is Empty</h3>
                <p class="text-gray-400 mb-6">Add items to your cart to continue</p>
                <a href="/shop" class="px-6 py-3 bg-gradient-to-r from-[#d4af37] to-[#b8941f] text-black font-bold rounded-lg hover:shadow-lg hover:shadow-[#d4af37]/20 transition-all">
                  Continue Shopping
                </a>
              </div>
            <% } %>
          </div>
        </div>

        <!-- Payment Method Section -->
       <!-- Payment Method Section -->
<div class="bg-gradient-to-br from-[#0b0b0b] to-[#151515] rounded-2xl border border-[#2a2a2a] p-6">
  <div class="mb-6 pb-4 border-b border-[#2a2a2a]">
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 rounded-lg bg-[#d4af37]/10 flex items-center justify-center">
        <svg class="w-5 h-5 text-[#d4af37]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/>
        </svg>
      </div>
      <h2 class="text-xl font-bold text-white">Payment Method</h2>
    </div>
  </div>
  
  <div class="space-y-3">
    <!-- Cash on Delivery Option -->
    <div class="border-2 rounded-xl p-4 transition-all" id="codOption">
      <div class="flex items-center gap-3 mb-2">
        <input 
  type="radio" 
  name="paymentMethod" 
  id="cod" 
  value="COD" 
  class="w-5 h-5 text-[#d4af37]"
  <%= parseFloat(finalAmount) > 2000 ? 'disabled' : '' %>
  <%= (parseFloat(finalAmount) <= 2000 && user.walletBalance < parseFloat(finalAmount)) ? 'checked' : '' %>
>

        <label for="cod" class="font-medium text-white cursor-pointer flex items-center gap-2">
          <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"/>
          </svg>
          Cash on Delivery (COD)
        </label>
      </div>
      <p class="text-gray-400 text-sm ml-8">Pay when your order is delivered</p>
      <% if (parseFloat(finalAmount) > 2000) { %>
  <p class="text-red-400 text-sm ml-8 mt-1">
    ‚ùå Cash on Delivery is not allowed for orders above ‚Çπ2000
  </p>
<% } %>

    </div>
    
   <!-- Wallet Payment Option -->
<!-- Wallet Payment Option -->
<% if (walletBalance && walletBalance > 0) { %>
<div class="border-2 rounded-xl p-4 transition-all" id="walletOption">
  <div class="flex items-center gap-3 mb-2">
    <input 
      type="radio" 
      name="paymentMethod" 
      id="wallet" 
      value="Wallet" 
      class="w-5 h-5 text-[#d4af37]"
      <%= (walletBalance >= parseFloat(finalAmount)) ? 'checked' : '' %>
    >
    <label for="wallet" class="font-medium text-white cursor-pointer flex items-center gap-2">
      <svg class="w-5 h-5 text-[#d4af37]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"/>
      </svg>
      Pay with Wallet
    </label>
  </div>
  <p class="text-gray-400 text-sm ml-8">
    Available balance: <span class="text-green-400 font-semibold">‚Çπ<%= walletBalance.toFixed(2) %></span>
    <% if (walletBalance < parseFloat(finalAmount)) { %>
    <span class="text-red-400 block mt-1">
      Insufficient balance. You need ‚Çπ<%= (parseFloat(finalAmount) - walletBalance).toFixed(2) %> more.
    </span>
    <% } else { %>
    <span class="text-green-400 block mt-1">
      ‚úì Sufficient balance available
    </span>
    <% } %>
  </p>
</div>
<% } %>
    
    <!-- Razorpay Option -->
    <div class="border-2 rounded-xl p-4 transition-all" id="razorpayOption">
      <div class="flex items-center gap-3 mb-2">
        <input 
          type="radio" 
          name="paymentMethod" 
          id="razorpay" 
          value="Razorpay" 
          class="w-5 h-5 text-[#d4af37]"
        >
        <label for="razorpay" class="font-medium text-white cursor-pointer flex items-center gap-2">
          <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
          </svg>
          Pay with Card/UPI/NetBanking
        </label>
      </div>
      <p class="text-gray-400 text-sm ml-8">Secure online payment via Razorpay</p>
    </div>
  </div>
</div>
      </div>

      <!-- Right Column - Order Summary -->
    <div class="lg:w-1/3">
  <div class="bg-gradient-to-br from-[#0b0b0b] to-[#151515] rounded-2xl border border-[#2a2a2a] p-6 sticky top-6">
    <div class="mb-6 pb-4 border-b border-[#2a2a2a]">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-lg bg-[#d4af37]/10 flex items-center justify-center">
          <svg class="w-5 h-5 text-[#d4af37]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
          </svg>
        </div>
        <h2 class="text-xl font-bold text-white">Price Summary</h2>
      </div>
    </div>
    
    <div class="space-y-3 mb-6">
      <!-- Subtotal -->
      <div class="flex justify-between text-gray-400">
        <span>Subtotal</span>
        <span class="text-white summary-subtotal">‚Çπ<%= subtotal %></span>
      </div>
      
      <!-- Tax -->
      <div class="flex justify-between text-gray-400">
        <span>Tax (10% GST)</span>
        <span class="text-white summary-tax">‚Çπ<%= tax %></span>
      </div>
      
      <!-- Discount - Always present but hidden when 0 -->
      <div class="flex justify-between text-green-400 summary-discount" style="<%= parseFloat(discount) > 0 ? '' : 'display: none;' %>">
        <span>Discount</span>
        <span class="discount-amount"><%= parseFloat(discount) > 0 ? '-‚Çπ' + discount : '-‚Çπ0.00' %></span>
      </div>
      
      <!-- Shipping -->
      <div class="flex justify-between text-gray-400">
        <span>Shipping Fee</span>
        <span class="<%= parseFloat(shipping) === 0 ? 'text-green-400' : 'text-white' %> summary-shipping">
          <% if (parseFloat(shipping) === 0) { %>
            FREE
          <% } else { %>
            ‚Çπ<%= shipping %>
          <% } %>
        </span>
      </div>
      
      <!-- Final Amount -->
      <div class="border-t border-[#2a2a2a] pt-3 mt-3">
        <div class="flex justify-between text-xl font-bold">
          <span class="text-white">Total Amount</span>
          <span class="text-[#d4af37] summary-final">‚Çπ<%= finalAmount %></span>
        </div>
      </div>
      
      <!-- Hidden data fields -->
      <div id="finalAmountData" data-amount="<%= finalAmount %>" style="display: none;"></div>
      <input type="hidden" id="walletBalanceData" value="<%= walletBalance || 0 %>">
    </div>
    
    <% if (cartItems && cartItems.length > 0) { %>
    <input 
      type="hidden" 
      id="cartItemsData" 
      value="true"
      data-items='<%= JSON.stringify(cartItems.map(item => ({
        productId: item.product?._id || item.product,
        variantId: item.variant?._id,
        quantity: item.quantity,
        price: item.price || 0,
        name: item.product?.name || "Product"
      }))) %>'
    />
    <% } %>
<button 
  id="openCouponModal"
  class="w-full mb-3 border border-[#d4af37]/40 text-[#d4af37] py-2 rounded-lg hover:bg-[#d4af37]/10 transition-all text-sm font-medium">
  View Available Coupons
</button>

          <!-- Coupon Section -->
<!-- Coupon Section -->
<div class="mb-6 coupon-section">
    <div class="flex items-center justify-between mb-3">
        <h3 class="font-medium text-white">Apply Coupon</h3>
        <!-- Remove button - initially hidden if no coupon -->
        <% if (appliedCoupon) { %>
        <button 
            id="removeCouponBtn"
            class="text-sm text-red-400 hover:text-red-300 transition-colors flex items-center gap-1"
        >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
            </svg>
            Remove
        </button>
        <% } else { %>
        <button 
            id="removeCouponBtn"
            class="text-sm text-red-400 hover:text-red-300 transition-colors flex items-center gap-1"
            style="display: none;"
        >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
            </svg>
            Remove
        </button>
        <% } %>
    </div>
    
    <!-- Applied Coupon Display (shown if coupon already applied on page load) -->
    <% if (appliedCoupon) { %>
    <div class="bg-gradient-to-r from-green-900/20 to-emerald-900/10 border border-green-500/30 rounded-xl p-4 mb-3 coupon-applied">
        <div class="flex justify-between items-center">
            <div>
                <div class="flex items-center gap-2">
                    <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <span class="font-bold text-green-400 coupon-code"><%= appliedCoupon.code %></span>
                    <span class="text-sm text-gray-300"><%= appliedCoupon.name %></span>
                </div>
                <p class="text-sm text-gray-400 mt-1">
                    <% if (appliedCoupon.discountType === 'percentage') { %>
                        <%= appliedCoupon.discountValue %>% OFF
                    <% } else { %>
                        ‚Çπ<%= appliedCoupon.discountValue %> OFF
                    <% } %>
                </p>
            </div>
            <span class="text-lg font-bold text-green-400">-‚Çπ<%= appliedCoupon.discountAmount.toFixed(2) %></span>
        </div>
    </div>
    <% } else { %>
    <!-- Coupon Input Section (shown if no coupon applied) -->
    <div class="flex gap-2 mb-3 coupon-input-section">
        <input 
            type="text" 
            id="couponCode"
            placeholder="Enter coupon code"
            class="flex-grow px-4 py-2 bg-[#0b0b0b]/50 border border-[#2a2a2a] rounded-lg text-white focus:border-[#d4af37] focus:outline-none transition-colors"
        >
        <button 
            id="applyCouponBtn"
            class="px-4 py-2 bg-gradient-to-r from-[#d4af37] to-[#b8941f] text-black font-semibold rounded-lg hover:shadow-lg hover:shadow-[#d4af37]/20 transition-all"
        >
            Apply
        </button>
    </div>
    <% } %>
    
    <!-- Coupon Message -->
    <div id="couponMessage" class="text-sm mt-2"></div>
</div>
  
  <!-- Coupon Message -->


          <!-- Place Order Button -->
          <button 
            id="placeOrderBtn"
            class="w-full bg-gradient-to-r from-[#d4af37] to-[#b8941f] hover:from-[#e4bf47] hover:to-[#c8a42f] text-black font-semibold py-3 px-4 rounded-lg hover:shadow-lg hover:shadow-[#d4af37]/20 transition-all flex items-center justify-center gap-2 disabled:from-gray-700 disabled:to-gray-800 disabled:text-gray-400 disabled:cursor-not-allowed disabled:hover:shadow-none"
            <%= (addresses && addresses.length > 0 && cartItems && cartItems.length > 0) ? '' : 'disabled' %>
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
            </svg>
            Place Order
          </button>
          
          <p class="text-xs text-gray-500 text-center mt-3">
            By placing your order, you agree to our 
            <a href="/terms" class="text-[#d4af37] hover:underline">Terms & Conditions</a>
          </p>
        </div>
      </div>
    </div>
  </div>
</main>

<!-- Address Modal -->
<div id="addressModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
  <div class="bg-gradient-to-br from-[#0b0b0b] to-[#151515] rounded-2xl shadow-2xl border border-[#2a2a2a] max-w-md w-full max-h-[90vh] overflow-y-auto">
    <div class="flex justify-between items-center p-6 border-b border-[#2a2a2a]">
      <h3 id="modalTitle" class="text-xl font-bold text-white">Add New Address</h3>
      <button id="closeModal" class="text-gray-400 hover:text-white text-2xl transition-colors">&times;</button>
    </div>
    
    <form id="addressForm" class="p-6">
      <input type="hidden" id="addressId" name="addressId">
      
      <div class="space-y-4">
        <div>
          <label for="fullName" class="block text-sm font-medium text-gray-400 mb-1">
            Full Name *
          </label>
          <input 
            type="text" 
            id="fullName" 
            name="fullName" 
            required
            class="w-full px-4 py-2 bg-[#0b0b0b]/50 border border-[#2a2a2a] rounded-lg text-white focus:border-[#d4af37] focus:outline-none transition-colors"
            placeholder="Enter full name"
          >
        </div>
        
        <div>
          <label for="phone" class="block text-sm font-medium text-gray-400 mb-1">
            Phone Number *
          </label>
          <input 
            type="tel" 
            id="phone" 
            name="phone" 
            required
            class="w-full px-4 py-2 bg-[#0b0b0b]/50 border border-[#2a2a2a] rounded-lg text-white focus:border-[#d4af37] focus:outline-none transition-colors"
            placeholder="Enter phone number"
          >
        </div>
        
        <div>
          <label for="addressLine1" class="block text-sm font-medium text-gray-400 mb-1">
            Address Line 1 *
          </label>
          <textarea 
            id="addressLine1" 
            name="addressLine1" 
            rows="2"
            required
            class="w-full px-4 py-2 bg-[#0b0b0b]/50 border border-[#2a2a2a] rounded-lg text-white focus:border-[#d4af37] focus:outline-none transition-colors resize-none"
            placeholder="House number, street, area"
          ></textarea>
        </div>
        
        <div>
          <label for="addressLine2" class="block text-sm font-medium text-gray-400 mb-1">
            Address Line 2 (Optional)
          </label>
          <input 
            type="text" 
            id="addressLine2" 
            name="addressLine2"
            class="w-full px-4 py-2 bg-[#0b0b0b]/50 border border-[#2a2a2a] rounded-lg text-white focus:border-[#d4af37] focus:outline-none transition-colors"
            placeholder="Apartment, suite, unit, etc."
          >
        </div>
        
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label for="city" class="block text-sm font-medium text-gray-400 mb-1">
              City *
            </label>
            <input 
              type="text" 
              id="city" 
              name="city" 
              required
              class="w-full px-4 py-2 bg-[#0b0b0b]/50 border border-[#2a2a2a] rounded-lg text-white focus:border-[#d4af37] focus:outline-none transition-colors"
              placeholder="City"
            >
          </div>
          
          <div>
            <label for="state" class="block text-sm font-medium text-gray-400 mb-1">
              State *
            </label>
            <input 
              type="text" 
              id="state" 
              name="state" 
              required
              class="w-full px-4 py-2 bg-[#0b0b0b]/50 border border-[#2a2a2a] rounded-lg text-white focus:border-[#d4af37] focus:outline-none transition-colors"
              placeholder="State"
            >
          </div>
        </div>
        
        <div>
          <label for="postalCode" class="block text-sm font-medium text-gray-400 mb-1">
            Postal Code *
          </label>
        <input 
  type="text"
  id="postalCode" 
  name="postalCode"
  required
  maxlength="6"
  inputmode="numeric"
  pattern="[0-9]{5,6}"
  class="w-full px-4 py-2 bg-[#0b0b0b]/50 border border-[#2a2a2a] rounded-lg text-white focus:border-[#d4af37] focus:outline-none transition-colors"
  placeholder="Postal code"
>

        </div>
        
        <div>
          <label for="country" class="block text-sm font-medium text-gray-400 mb-1">
            Country *
          </label>
          <input 
            type="text" 
            id="country" 
            name="country" 
            value="India"
            required
            class="w-full px-4 py-2 bg-[#0b0b0b]/50 border border-[#2a2a2a] rounded-lg text-white focus:border-[#d4af37] focus:outline-none transition-colors"
          >
        </div>
        
        <div>
          <label for="addressType" class="block text-sm font-medium text-gray-400 mb-1">
            Address Type
          </label>
          <select 
            id="addressType" 
            name="addressType"
            class="w-full px-4 py-2 bg-[#0b0b0b]/50 border border-[#2a2a2a] rounded-lg text-white focus:border-[#d4af37] focus:outline-none transition-colors"
          >
            <option value="home">Home</option>
            <option value="work">Work</option>
            <option value="other">Other</option>
          </select>
        </div>
        
        <div class="flex items-center">
          <input 
            type="checkbox" 
            id="isDefault" 
            name="isDefault"
            class="w-4 h-4 bg-[#0b0b0b]/50 border-[#2a2a2a] rounded focus:ring-[#d4af37] text-[#d4af37]"
          >
          <label for="isDefault" class="ml-2 text-sm text-gray-300">
            Set as default address
          </label>
        </div>
      </div>
      
      <div class="flex gap-3 mt-8">
        <button 
          type="button" 
          id="cancelBtn"
          class="flex-1 px-4 py-2 border border-[#2a2a2a] text-gray-400 rounded-lg hover:bg-[#1a1a1a] hover:text-white transition-colors"
        >
          Cancel
        </button>
        <button 
          type="submit" 
          id="saveAddressBtn"
          class="flex-1 px-4 py-2 bg-gradient-to-r from-[#d4af37] to-[#b8941f] text-black font-semibold rounded-lg hover:shadow-lg hover:shadow-[#d4af37]/20 transition-all flex items-center justify-center gap-2"
        >
          <span>Save Address</span>
          <svg class="w-4 h-4 hidden animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
          </svg>
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Success Modal -->
<div id="successModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
  <div class="bg-gradient-to-br from-[#0b0b0b] to-[#151515] rounded-2xl shadow-2xl border border-[#2a2a2a] max-w-md w-full">
    <div class="p-8 text-center">
      <div class="text-green-500 text-6xl mb-6">
        <svg class="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
      </div>
      
      <h2 class="text-2xl font-bold text-white mb-4">
        Thank You for Your Order! üéâ
      </h2>
      
      <p class="text-gray-400 mb-6">
        Your order has been placed successfully.
      </p>
      
      <div class="bg-[#1a1a1a] border border-[#2a2a2a] rounded-xl p-4 mb-6">
        <p class="font-medium text-white mb-2">
          Order Number: <span id="orderNumberDisplay" class="text-[#d4af37]"></span>
        </p>
        <p class="text-sm text-gray-400">
          You can track your order from your orders page.
        </p>
      </div>
      
      <div class="flex flex-col gap-3">
        <a 
          href="#"
          id="orderDetailsLink"
          class="w-full bg-gradient-to-r from-[#d4af37] to-[#b8941f] text-black font-semibold py-3 px-4 rounded-lg hover:shadow-lg hover:shadow-[#d4af37]/20 transition-all flex items-center justify-center gap-2"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
          </svg>
          View Order Details
        </a>
        
        <a 
          href="/shop"
          class="w-full border border-[#2a2a2a] text-gray-300 hover:bg-[#1a1a1a] hover:text-white font-semibold py-3 px-4 rounded-lg transition-colors flex items-center justify-center gap-2"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"/>
          </svg>
          Continue Shopping
        </a>
      </div>
    </div>
  </div>
</div>
<!-- Order Failed Modal -->
<div id="failedModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
  <div class="bg-gradient-to-br from-[#0b0b0b] to-[#151515] rounded-2xl shadow-2xl border border-red-500/30 max-w-md w-full">
    <div class="p-8 text-center">
      
      <!-- Icon -->
      <div class="text-red-500 text-6xl mb-6">
        ‚ùå
      </div>

      <h2 class="text-2xl font-bold text-white mb-3">
        Order Failed
      </h2>

      <p id="failedMessage" class="text-gray-400 mb-6">
        Something went wrong while placing your order.
      </p>

      <div class="flex flex-col gap-3">
        <button onclick="retryRazorpayPayment()"
          class="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-3 rounded-lg transition-all"
        >
          Try Again
        </button>

        <a 
          href="/user/cart"
          class="w-full border border-[#2a2a2a] text-gray-300 hover:bg-[#1a1a1a] hover:text-white font-semibold py-3 rounded-lg transition-colors"
        >
          Go to Cart
        </a>
      </div>
    </div>
  </div>
</div>
<!-- Coupon Modal -->
<div id="couponModal" class="fixed inset-0 bg-black/60 hidden z-50 flex items-center justify-center p-4">
  <div class="bg-gradient-to-br from-[#0b0b0b] to-[#151515] border border-[#2a2a2a] rounded-2xl w-full max-w-md shadow-2xl">
    
    <!-- Header -->
    <div class="flex justify-between items-center p-5 border-b border-[#2a2a2a]">
      <h3 class="text-lg font-bold text-white">Available Coupons</h3>
      <button id="closeCouponModal" class="text-gray-400 hover:text-white text-xl">&times;</button>
    </div>

    <!-- Coupon List -->
    <div class="p-5 space-y-4 max-h-[60vh] overflow-y-auto">

      <% if (availableCoupons && availableCoupons.length > 0) { %>
        <% availableCoupons.forEach(coupon => { %>
          <div class="border border-[#2a2a2a] rounded-xl p-4 hover:border-[#d4af37]/40 transition-all">
            
            <div class="flex justify-between items-center mb-2">
              <span class="text-[#d4af37] font-bold tracking-widest">
                <%= coupon.code %>
              </span>

              <button 
                class="applyCouponFromModal text-xs px-3 py-1 rounded-full bg-[#d4af37] text-black font-semibold hover:opacity-90"
                data-code="<%= coupon.code %>">
                Apply
              </button>
            </div>

            <p class="text-sm text-gray-400">
              <%= coupon.name %>
            </p>

            <p class="text-xs text-green-400 mt-1">
              <% if (coupon.discountType === 'percentage') { %>
                <%= coupon.discountValue %>% OFF
              <% } else { %>
                ‚Çπ<%= coupon.discountValue %> OFF
              <% } %>
            </p>

            <% if (coupon.minPurchase) { %>
              <p class="text-xs text-gray-500 mt-1">
                Min purchase ‚Çπ<%= coupon.minPurchase %>
              </p>
            <% } %>

          </div>
        <% }) %>
      <% } else { %>
        <p class="text-gray-400 text-center">No coupons available</p>
      <% } %>

    </div>
  </div>
</div>


<!-- Toast Container -->
<div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>

<!-- Custom Scrollbar Styles -->
<style>
  /* Custom scrollbar for address modal */
  #addressModal div::-webkit-scrollbar {
    width: 6px;
  }
  
  #addressModal div::-webkit-scrollbar-track {
    background: transparent;
  }
  
  #addressModal div::-webkit-scrollbar-thumb {
    background: linear-gradient(to bottom, #d4af37, #b8941f);
    border-radius: 3px;
  }
  
  #addressModal div::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(to bottom, #e4bf47, #c8a42f);
  }

  /* Animation for fade in */
  @keyframes fade-in {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .animate-fade-in {
    animation: fade-in 0.3s ease-out;
  }

  /* Spinner animation */
  @keyframes spin {
    from {
      transform: rotate(0deg);
    }
    to {
      transform: rotate(360deg);
    }
  }

  .animate-spin {
    animation: spin 1s linear infinite;
  }
</style>

<!-- JavaScript (Keep your existing JS functionality) -->
<script>
  // Your existing JavaScript code for address management and checkout
  // Keep all the functionality from your working version
</script>