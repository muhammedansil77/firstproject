

<div class="admin-content-page px-4 py-4"
     style="width:100%; max-width:100%; margin:0; background: #f8f9fa; min-height:100vh;">

  <div class="container" style="max-width:1200px;">
    <!-- âœ… EVERYTHING ELSE FROM YOUR FILE STAYS HERE -->


  <!-- Header Section -->
  <div class="bg-white shadow-sm rounded-3 p-4 mb-4">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <h2 class="mb-1 fw-bold" style="color: #1a1a1a; font-size: 28px;">Product Management</h2>
        <p class="text-muted mb-0 small">Manage your product catalog and inventory</p>
      </div>
      <div class="d-flex gap-2">
        <button id="reloadBtn" class="btn btn-outline-secondary px-4">
          <i class="bi bi-arrow-clockwise me-2"></i>Reload
        </button>
        <button class="btn btn-success px-4" data-bs-toggle="modal" data-bs-target="#addProductModal" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); border: none;">
          <i class="bi bi-plus-circle me-2"></i>Add Product
        </button>
      </div>
    </div>
  </div>

  <!-- Filters Section -->
  <div class="bg-white shadow-sm rounded-3 p-4 mb-4">
    <div class="row g-3 align-items-center">
      <div class="col-lg-4 col-md-6">
        <div class="position-relative">
          <i class="bi bi-search position-absolute top-50 translate-middle-y ms-3" style="color: #6c757d;"></i>
          <input id="productSearchInput" class="form-control ps-5" type="search" placeholder="Search products by name or description..." style="border-radius: 10px; border: 1px solid #e0e0e0;" />
        </div>
      </div>

      <div class="col-lg-3 col-md-6">
        <select id="productCategoryFilter" class="form-select" style="border-radius: 10px; border: 1px solid #e0e0e0;">
          <option value="all">All Categories</option>
          <% (categories || []).forEach(cat => { %>
            <option value="<%= cat._id %>"><%= cat.name %></option>
          <% }) %>
        </select>
      </div>
      <div class="col-lg-2 col-md-4">
      <select id="productStatusFilter" class="form-select" style="border-radius: 10px; border: 1px solid #e0e0e0;">
        <option value="all">All Status</option>
        <option value="active">Active</option>
        <option value="blocked">Blocked</option>
           <option value="name_asc">A-Z (Name)</option>
    <option value="name_desc">Z-A (Name)</option>
    <option value="newest">Newest First</option>
    <option value="oldest">Oldest First</option>
      </select>
    </div>

      <div class="col-lg-2 col-md-4">
        <select id="productLimitSelect" class="form-select" style="border-radius: 10px; border: 1px solid #e0e0e0;">
          <option value="5">5 per page</option>
          <option value="10" selected>10 per page</option>
          <option value="25">25 per page</option>
          <option value="50">50 per page</option>
        </select>
      </div>

      <div class="col-lg-3 col-md-8 text-end">
        <small class="text-muted fw-medium" id="productsCountLabel" style="font-size: 14px;"></small>
      </div>
    </div>
  </div>


  <div class="bg-white shadow-sm rounded-3 overflow-hidden">
    <table class="table table-hover align-middle mb-0" id="productTable" style="border: none;">
      <thead style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-bottom: 2px solid #dee2e6;">
        <tr>
          <th class="py-3 px-4" style="width:140px; font-weight: 600; color: #495057;">Thumbnail</th>
          <th class="py-3 px-4" style="font-weight: 600; color: #495057;">Product Details</th>
          <th class="py-3 px-4" style="font-weight: 600; color: #495057;">Category</th>
          <th class="py-3 px-4 text-center" style="font-weight: 600; color: #495057;">Variants</th>
          <th class="py-3 px-4 text-center">Status</th>
          <th class="py-3 px-4 text-center" style="width:180px; font-weight: 600; color: #495057;">Actions</th>
        </tr>
      </thead>
      <tbody id="productTableBody">
        <% if (!products || products.length === 0) { %>
          <tr>
            <td colspan="5" class="text-center py-5">
              <div class="text-muted">
                <i class="bi bi-inbox" style="font-size: 48px; opacity: 0.3;"></i>
                <p class="mt-3 mb-0">No products found</p>
              </div>
            </td>
          </tr>
        <% } else { %>
          <% products.forEach(product => { %>
            <tr data-id="<%= product._id %>" style="border-bottom: 1px solid #f0f0f0; transition: all 0.2s;">
              <td class="px-4">
               <%
  let thumb = '/uploads/placeholder.png';

  if (product.images && product.images.length) {
    thumb = product.images[0].startsWith('http')
      ? product.images[0]
      : '/' + product.images[0];
  } else if (product.variants && product.variants.length) {
    const v0 = product.variants[0];
    if (v0 && v0.images && v0.images.length) {
      thumb = v0.images[0].startsWith('http')
        ? v0.images[0]
        : '/' + v0.images[0];
    }
  }
%>

                <div class="position-relative" style="width: 120px; height: 90px; overflow: hidden; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                  <img src="<%= thumb %>" style="width: 100%; height: 100%; object-fit: cover;<%= (thumb.endsWith('placeholder.png') ? 'opacity:0.4;' : '') %>" />
                </div>
              </td>
              <td class="px-4">
                <div class="fw-semibold mb-1" style="color: #1a1a1a; font-size: 15px;"><%= product.name %></div>
                <div class="text-muted small" style="line-height: 1.4;"><%= product.description ? product.description.substring(0,90) + (product.description.length > 90 ? '...' : '') : 'No description' %></div>
              </td>
              <td class="px-4">
                <span class="badge rounded-pill px-3 py-2" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); color: #1976d2; font-weight: 500;">
                  <%= product.category ? product.category.name || product.category : 'Uncategorized' %>
                </span>
              </td>
              <td class="px-4 text-center">
                <span class="badge bg-secondary rounded-pill px-3 py-2" style="font-size: 13px; font-weight: 500;">
                  <%= product.variants ? product.variants.length : 0 %>
                </span>
              </td>
              <td class="px-4 text-center">
                <div class="d-flex gap-2 justify-content-center">
                  <button class="btn btn-sm btn-outline-primary editBtn px-3" data-id="<%= product._id %>" style="border-radius: 8px;">
                    <i class="bi bi-pencil me-1"></i>Edit
                  </button>
                  <!-- <button class="btn btn-sm btn-outline-danger deleteBtn px-3" data-id="<%= product._id %>" style="border-radius: 8px;">
                    <i class="bi bi-trash me-1"></i>Delete
                  </button> -->
                </div>
              </td>
            </tr>
          <% }) %>
        <% } %>
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <nav aria-label="Product pagination" class="mt-4">
    <ul id="productPagination" class="pagination justify-content-center"></ul>
  </nav>
</div>

<!-- Add Product Modal -->
<div class="modal fade" id="addProductModal" tabindex="-1" aria-hidden="true" aria-labelledby="addProductModalLabel">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content" style="border-radius: 16px; border: none; box-shadow: 0 10px 40px rgba(0,0,0,0.15);">
      <form id="addProductForm" novalidate enctype="multipart/form-data" method="post">
        <div class="modal-header" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; border: none; padding: 24px 32px;">
          <div>
            <h5 class="modal-title mb-1 fw-bold" id="addProductModalLabel" style="font-size: 24px;">Add New Product</h5>
            <p class="mb-0 small" style="opacity: 0.9;">Fill in the product details and variants</p>
          </div>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

<div class="modal-body" id="addProductModalBody" style="padding: 32px; background: #ffffff;">
          <!-- Basic Information -->
          <div class="bg-white rounded-3 p-4 mb-4 shadow-sm">
            <h6 class="fw-bold mb-3" style="color: #1a1a1a; font-size: 16px;">
              <i class="bi bi-info-circle me-2"></i>Basic Information
            </h6>
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label fw-semibold">Product Name *</label>
                <input id="pName" name="name" class="form-control" type="text" required style="border-radius: 10px; border: 1px solid #e0e0e0; padding: 12px;">
              </div>

              <div class="col-md-6">
                <label class="form-label fw-semibold">Category</label>
                <select id="pCategory" name="category" class="form-select" style="border-radius: 10px; border: 1px solid #e0e0e0; padding: 12px;">
                  <option value="">-- Select category --</option>
                  <% (categories || []).forEach(cat => { %>
                    <option value="<%= cat._id %>"><%= cat.name %></option>
                  <% }) %>
                </select>
              </div>

              <div class="col-12">
                <label class="form-label fw-semibold">Description</label>
                <textarea id="pDescription" name="description" class="form-control" rows="4" style="border-radius: 10px; border: 1px solid #e0e0e0; padding: 12px;"></textarea>
              </div>
            </div>
          </div>

          <!-- Image Cropper Area -->
          <div id="addCropArea" style="display:none; margin-bottom:20px; width:100%;">
            <div class="bg-white rounded-3 p-4 shadow-sm">
              <div id="addCropControls" style="display:none; gap:8px; align-items:center; margin-bottom:16px;">
                <button type="button" id="addCropApply" class="btn btn-primary px-4" style="border-radius: 8px;">
                  <i class="bi bi-check-circle me-2"></i>Apply Crop
                </button>
                <button type="button" id="addCropNext" class="btn btn-secondary px-4" style="border-radius: 8px;">
                  <i class="bi bi-arrow-right me-2"></i>Next
                </button>
                <button type="button" id="addCropCancel" class="btn btn-outline-secondary px-4" style="border-radius: 8px;">
                  <i class="bi bi-x-circle me-2"></i>Cancel
                </button>
                <div style="flex:1;"></div>
              </div>
              <div style="overflow:auto; text-align:center;">
                <img id="addCropImage" alt="Crop preview" style="max-width:100%; height:auto; display:block; margin:0 auto;" />
              </div>
            </div>
          </div>

          <!-- Product Images -->
          <div class="bg-white rounded-3 p-4 mb-4 shadow-sm">
            <h6 class="fw-bold mb-3" style="color: #1a1a1a; font-size: 16px;">
              <i class="bi bi-images me-2"></i>Product Images (Optional)
            </h6>
            <input id="pImages" type="file" name="productImages[]" accept="image/*" multiple class="form-control" style="border-radius: 10px; border: 1px solid #e0e0e0; padding: 12px;" />
            <div id="pImagesPreview" class="d-flex gap-3 flex-wrap mt-3"></div>
            <div class="alert alert-info mt-3 mb-0" style="border-radius: 10px; border-left: 4px solid #0dcaf0;">
              <i class="bi bi-info-circle me-2"></i>Product images are optional. Each variant must have at least <strong>3 images</strong>.
            </div>
          </div>

          <!-- Variants Section -->
          <div class="bg-white rounded-3 p-4 shadow-sm">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h6 class="mb-0 fw-bold" style="color: #1a1a1a; font-size: 16px;">
                <i class="bi bi-box-seam me-2"></i>Product Variants
              </h6>
              <button type="button" id="addVariantBtn" class="btn btn-outline-primary px-4" style="border-radius: 8px;">
                <i class="bi bi-plus-circle me-2"></i>Add Variant
              </button>
            </div>

            <div id="variantsContainer"></div>
            <div class="alert alert-warning mt-3 mb-0" style="border-radius: 10px; border-left: 4px solid #ffc107;">
              <i class="bi bi-exclamation-triangle me-2"></i>Each variant must have at least <strong>3 images</strong>, stock, price, and color.
            </div>
          </div>
        </div>

        <div class="modal-footer" style="background: white; border-top: 1px solid #e0e0e0; padding: 20px 32px;">
          <button type="button" class="btn btn-light px-4" data-bs-dismiss="modal" style="border-radius: 8px;">Cancel</button>
          <button id="addProductSubmit" type="submit" class="btn btn-success px-5" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); border: none; border-radius: 8px;">
            <i class="bi bi-check-circle me-2"></i>Add Product
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit Product Modal -->
<div class="modal fade" id="editProductModal" tabindex="-1" aria-hidden="true">
 <div class="modal-dialog modal-xl">

    <div class="modal-content" style="border-radius: 16px; border: none; box-shadow: 0 10px 40px rgba(0,0,0,0.15); max-height: 90vh;">
      <form id="editProductForm" novalidate>
        <div class="modal-header" style="background: linear-gradient(135deg, #0d6efd 0%, #0dcaf0 100%); color: white; border: none; padding: 24px 32px; position: sticky; top: 0; z-index: 10;">
          <div>
            <h5 class="modal-title mb-1 fw-bold" style="font-size: 24px;">Edit Product</h5>
            <p class="mb-0 small" style="opacity: 0.9;">Update product information and variants</p>
          </div>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>

<div class="modal-body" style="padding: 32px; background: #ffffff; overflow-y: auto;">
          <input type="hidden" id="editProductId" />

          <!-- Basic Information -->
          <div class="bg-white rounded-3 p-4 mb-4 shadow-sm">
            <h6 class="fw-bold mb-3" style="color: #1a1a1a; font-size: 16px;">
              <i class="bi bi-info-circle me-2"></i>Basic Information
            </h6>
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label fw-semibold">Product Name *</label>
                <input id="editName" name="name" class="form-control" required style="border-radius: 10px; border: 1px solid #e0e0e0; padding: 12px;">
              </div>

              <div class="col-md-6">
                <label class="form-label fw-semibold">Category</label>
                <select id="editCategory" name="category" class="form-select" style="border-radius: 10px; border: 1px solid #e0e0e0; padding: 12px;">
                  <option value="">-- Select category --</option>
                  <% (categories || []).forEach(cat => { %>
                    <option value="<%= cat._id %>"><%= cat.name %></option>
                  <% }) %>
                </select>
              </div>

              <div class="col-12">
                <label class="form-label fw-semibold">Description</label>
                <textarea id="editDescription" name="description" class="form-control" rows="4" style="border-radius: 10px; border: 1px solid #e0e0e0; padding: 12px;"></textarea>
              </div>
            </div>
          </div>
     
          <div class="bg-white rounded-3 p-4 mb-4 shadow-sm">
            <h6 class="fw-bold mb-3" style="color: #1a1a1a; font-size: 16px;">
              <i class="bi bi-images me-2"></i>Main Images
            </h6>
            <input id="editImages" type="file" name="productImages[]" accept="image/*" multiple class="form-control" style="border-radius: 10px; border: 1px solid #e0e0e0; padding: 12px;" />
            <div id="editImagesPreview" class="d-flex gap-3 flex-wrap mt-3"></div>
            <div id="editExistingImages" class="d-flex gap-3 flex-wrap mt-3"></div>
            <div class="alert alert-info mt-3 mb-0" style="border-radius: 10px; border-left: 4px solid #0dcaf0;">
              <i class="bi bi-info-circle me-2"></i>If you replace main images, choose at least 3 files.
            </div>
          </div>
          
<div id="editCropArea" style="display:none; margin-bottom:20px; width:100%;">
  <div class="bg-white rounded-3 p-4 shadow-sm">
    <div id="editCropControls" style="display:none; gap:8px; align-items:center; margin-bottom:16px;">
      <button type="button" id="editCropApply" class="btn btn-primary px-4" style="border-radius: 8px;">
        <i class="bi bi-check-circle me-2"></i>Apply Crop
      </button>
      <button type="button" id="editCropNext" class="btn btn-secondary px-4" style="border-radius: 8px;">
        <i class="bi bi-arrow-right me-2"></i>Next
      </button>
      <button type="button" id="editCropCancel" class="btn btn-outline-secondary px-4" style="border-radius: 8px;">
        <i class="bi bi-x-circle me-2"></i>Cancel
      </button>
      <div style="flex:1;"></div>
    </div>
    <div style="overflow:auto; text-align:center;">
      <img id="editCropImage" alt="Crop preview" style="max-width:100%; height:auto; display:block; margin:0 auto;" />
    </div>
  </div>
</div>

          <!-- Variants Section -->
          <div class="bg-white rounded-3 p-4 shadow-sm">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h6 class="mb-0 fw-bold" style="color: #1a1a1a; font-size: 16px;">
                <i class="bi bi-box-seam me-2"></i>Product Variants
              </h6>
              <button type="button" id="editAddVariantBtn" class="btn btn-outline-primary px-4" style="border-radius: 8px;">
                <i class="bi bi-plus-circle me-2"></i>Add Variant
              </button>
            </div>

            <div id="editVariantsContainer"></div>
            <div class="alert alert-warning mt-3 mb-0" style="border-radius: 10px; border-left: 4px solid #ffc107;">
              <i class="bi bi-exclamation-triangle me-2"></i>Each variant must have at least <strong>3 images</strong>.
            </div>
          </div>
        </div>

        <div class="modal-footer" style="background: white; border-top: 1px solid #e0e0e0; padding: 20px 32px; position: sticky; bottom: 0; z-index: 10;">
          <button type="button" class="btn btn-light px-4" data-bs-dismiss="modal" style="border-radius: 8px;">Cancel</button>
          <button id="editProductSubmit" type="submit" class="btn btn-primary px-5" style="background: linear-gradient(135deg, #0d6efd 0%, #0dcaf0 100%); border: none; border-radius: 8px;">
            <i class="bi bi-check-circle me-2"></i>Save Changes
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Variant Template -->
<template id="variantTpl">
  <div class="card mb-3 variant-row shadow-sm"
     data-idx=""
     data-variant-id=""
 style="border: 1px solid #e0e0e0; border-radius: 12px; overflow: hidden;">
    <div class="card-header d-flex justify-content-between align-items-center" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-bottom: 1px solid #e0e0e0; padding: 16px 20px;">
      <strong style="color: #1a1a1a; font-size: 15px;">
        <i class="bi bi-box me-2"></i>Variant
      </strong>
      <button type="button" class="btn btn-sm btn-outline-danger removeVariantBtn px-3" style="border-radius: 8px;">
        <i class="bi bi-trash me-1"></i>Remove
      </button>
    </div>

    <div class="card-body p-4">
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label fw-semibold">Variant Images (select 3+) *</label>
          <input type="file" accept="image/*" class="form-control variant-image" multiple required style="border-radius: 10px; border: 1px solid #e0e0e0; padding: 12px;">
          <div class="variant-image-preview mt-3 d-flex gap-2 flex-wrap"></div>
          <div class="alert alert-light mt-3 mb-0 small" style="border-radius: 8px; border: 1px solid #e0e0e0;">
            <i class="bi bi-camera me-1"></i>Choose 3 images for this variant. After selecting, crop each image one by one using the cropper.
          </div>
        </div>

        <div class="col-md-6">
          <div class="row g-3">
            <div class="col-12">
              <label class="form-label fw-semibold">Color *</label>
              <select class="form-select variant-color" required style="border-radius: 10px; border: 1px solid #e0e0e0; padding: 12px;">
                <option value="">Select color</option>
                <option value="black">Black</option>
                <option value="brown">Brown</option>
              </select>
            </div>

            <div class="col-12">
              <label class="form-label fw-semibold">Stock Quantity *</label>
              <input type="number" min="0" class="form-control variant-stock" required style="border-radius: 10px; border: 1px solid #e0e0e0; padding: 12px;">
            </div>

            <div class="col-12">
              <label class="form-label fw-semibold">Price *</label>
              <div class="input-group">
                <span class="input-group-text" style="border-radius: 10px 0 0 10px; border: 1px solid #e0e0e0;">$</span>
                <input type="number" min="0" step="0.01" class="form-control variant-price" required style="border-radius: 0 10px 10px 0; border: 1px solid #e0e0e0; padding: 12px;">
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
    </div>
</template>

