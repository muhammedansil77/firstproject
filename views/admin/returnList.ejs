<!-- views/admin/returns/returnList.ejs -->
<div class="container-fluid px-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center py-3 mb-4 border-bottom">
        <div>
            <h1 class="h3 mb-0 text-dark">
                <i class="fas fa-exchange-alt me-2"></i>
                Return & Refund Management
            </h1>
            <p class="text-muted mb-0">Manage customer returns and refund requests</p>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-primary" onclick="window.print()">
                <i class="fas fa-print me-1"></i> Print
            </button>
           <button class="btn btn-outline-success" id="exportBtn">

                <i class="fas fa-file-export me-1"></i> Export
            </button>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-start border-primary border-3 shadow-sm h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs fw-bold text-primary text-uppercase mb-1">
                                Total Returns
                            </div>
                            <div class="h5 mb-0 fw-bold text-gray-800"><%= returnStats.total %></div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-exchange-alt fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-start border-warning border-3 shadow-sm h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs fw-bold text-warning text-uppercase mb-1">
                                Pending
                            </div>
                            <div class="h5 mb-0 fw-bold text-gray-800"><%= returnStats.pending %></div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-clock fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-start border-info border-3 shadow-sm h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs fw-bold text-info text-uppercase mb-1">
                                Approved
                            </div>
                            <div class="h5 mb-0 fw-bold text-gray-800"><%= returnStats.approved %></div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-check-circle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-start border-success border-3 shadow-sm h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs fw-bold text-success text-uppercase mb-1">
                                Completed
                            </div>
                            <div class="h5 mb-0 fw-bold text-gray-800"><%= returnStats.completed %></div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-check-double fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters & Search Card -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <form id="filterForm" method="GET" action="/admin/returns">
                <input type="hidden" name="page" value="1">
                
                <div class="row g-3">
                    <!-- Search Input -->
                    <div class="col-md-3">
                        <label class="form-label text-dark fw-bold">Search</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light border-end-0">
                                <i class="fas fa-search text-muted"></i>
                            </span>
                            <input type="text" 
                                   name="search" 
                                   value="<%= searchQuery || '' %>" 
                                   class="form-control border-start-0" 
                                   placeholder="Search return ID, order, customer...">
                        </div>
                    </div>
                    
                    <!-- Status Filter -->
                    <div class="col-md-2">
                        <label class="form-label text-dark fw-bold">Status</label>
                        <select name="status" class="form-select">
                            <option value="all" <%= statusFilter === 'all' ? 'selected' : '' %>>All Status</option>
                            <option value="pending" <%= statusFilter === 'pending' ? 'selected' : '' %>>Pending</option>
                            <option value="approved" <%= statusFilter === 'approved' ? 'selected' : '' %>>Approved</option>
                            <option value="pickup_scheduled" <%= statusFilter === 'pickup_scheduled' ? 'selected' : '' %>>Pickup Scheduled</option>
                            <option value="picked_up" <%= statusFilter === 'picked_up' ? 'selected' : '' %>>Picked Up</option>
                            <option value="refund_initiated" <%= statusFilter === 'refund_initiated' ? 'selected' : '' %>>Refund Initiated</option>
                            <option value="refund_completed" <%= statusFilter === 'refund_completed' ? 'selected' : '' %>>Refund Completed</option>
                            <option value="rejected" <%= statusFilter === 'rejected' ? 'selected' : '' %>>Rejected</option>
                        </select>
                    </div>
                    
                    <!-- Refund Method Filter -->
                    <div class="col-md-2">
                        <label class="form-label text-dark fw-bold">Refund Method</label>
                        <select name="method" class="form-select">
                            <option value="all" <%= methodFilter === 'all' ? 'selected' : '' %>>All Methods</option>
                            <option value="original_method" <%= methodFilter === 'original_method' ? 'selected' : '' %>>Original Payment</option>
                            <option value="bank_transfer" <%= methodFilter === 'bank_transfer' ? 'selected' : '' %>>Bank Transfer</option>
                            <option value="upi" <%= methodFilter === 'upi' ? 'selected' : '' %>>UPI</option>
                            <option value="wallet_credit" <%= methodFilter === 'wallet_credit' ? 'selected' : '' %>>Wallet Credit</option>
                        </select>
                    </div>
                    
                    <!-- Sort Options -->
                    <div class="col-md-2">
                        <label class="form-label text-dark fw-bold">Sort By</label>
                        <select name="sort" class="form-select">
                            <option value="newest" <%= sortBy === 'newest' ? 'selected' : '' %>>Newest First</option>
                            <option value="oldest" <%= sortBy === 'oldest' ? 'selected' : '' %>>Oldest First</option>
                            <option value="amount-high" <%= sortBy === 'amount-high' ? 'selected' : '' %>>Amount: High to Low</option>
                            <option value="amount-low" <%= sortBy === 'amount-low' ? 'selected' : '' %>>Amount: Low to High</option>
                            <option value="status" <%= sortBy === 'status' ? 'selected' : '' %>>Status (A-Z)</option>
                        </select>
                    </div>
                    
                    <!-- Date Range -->
                    <div class="col-md-3">
                        <label class="form-label text-dark fw-bold">Date Range</label>
                        <div class="row g-2">
                            <div class="col-6">
                                <input type="date" 
                                       name="startDate" 
                                       value="<%= startDate || '' %>" 
                                       class="form-control" 
                                       placeholder="From">
                            </div>
                            <div class="col-6">
                                <input type="date" 
                                       name="endDate" 
                                       value="<%= endDate || '' %>" 
                                       class="form-control" 
                                       placeholder="To">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="col-md-3 d-flex align-items-end gap-2">
                        <button type="submit" class="btn btn-primary flex-grow-1">
                            <i class="fas fa-filter me-1"></i> Apply Filters
                        </button>
                        <button type="button" onclick="clearFilters()" class="btn btn-outline-secondary">
                            <i class="fas fa-times me-1"></i> Clear
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Returns Table -->
    <div class="card shadow-sm">
        <div class="card-header bg-white py-3">
            <h5 class="mb-0 text-dark fw-bold">
                <i class="fas fa-list me-2"></i>
                Return Requests 
                <% if (statusFilter !== 'all' || methodFilter !== 'all' || searchQuery || startDate || endDate) { %>
                    (Filtered: <%= returns.length %> of <%= totalReturns %>)
                <% } else { %>
                    (Total: <%= totalReturns %>)
                <% } %>
            </h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="ps-4">Return ID</th>
                            <th>Order Details</th>
                            <th>Customer</th>
                            <th>Product</th>
                            <th>Return Reason</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Request Date</th>
                            <th class="text-end pe-4">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% if (returns && returns.length > 0) { %>
                            <% returns.forEach(returnReq => { 
                                const order = returnReq.order || {};
                                const user = returnReq.user || {};
                                const item = returnReq.items && returnReq.items[0] ? returnReq.items[0] : {};
                            %>
                            <tr class="align-middle">
                                <td class="ps-4">
                                    <div class="fw-bold text-dark">
                                        <a href="/admin/returns/<%= returnReq._id %>" class="text-decoration-none text-dark">
                                            <%= returnReq.displayId %>
                                        </a>
                                    </div>
                                    <small class="text-muted">Order: <%= order.orderNumber || 'N/A' %></small>
                                </td>
                                <td>
                                    <div class="fw-bold text-dark">
                                        <%= order.orderNumber || 'Order N/A' %>
                                    </div>
                                    <small class="text-muted">
                                        <%= new Date(order.createdAt).toLocaleDateString('en-IN') %>
                                    </small>
                                </td>
                                <td>
                                    <div class="fw-bold text-dark">
                                        <%= user.fullName || 'N/A' %>
                                    </div>
                                    <small class="text-muted">
                                        <%= user.email || 'N/A' %>
                                    </small>
                                    <% if (user.phone) { %>
                                        <div class="text-muted small">
                                            <i class="fas fa-phone me-1"></i><%= user.phone %>
                                        </div>
                                    <% } %>
                                </td>
                                <td>
                                    <div class="fw-bold text-dark">
                                        <%= item.product?.name || 'Product N/A' %>
                                    </div>
                                    <% if (item.variant?.color || item.variant?.size) { %>
                                        <small class="text-muted">
                                            <%= item.variant?.color || '' %> 
                                            <%= item.variant?.size ? 'Size: ' + item.variant.size : '' %>
                                        </small>
                                    <% } %>
                                </td>
                                <td>
                                    <div class="fw-bold text-dark">
                                        <%= returnReq.reason || 'No reason provided' %>
                                    </div>
                                    <% if (returnReq.additionalDetails) { %>
                                        <small class="text-muted" title="<%= returnReq.additionalDetails %>">
                                            <i class="fas fa-info-circle"></i> Additional details
                                        </small>
                                    <% } %>
                                </td>
                                <td>
                                    <div class="fw-bold text-dark">
                                        <%= returnReq.formattedAmount %>
                                    </div>
                                    <small class="text-muted">
                                        <%= returnReq.refundMethod === 'original_method' ? 'Original Payment' : 
                                           returnReq.refundMethod === 'bank_transfer' ? 'Bank Transfer' :
                                           returnReq.refundMethod === 'upi' ? 'UPI' :
                                           returnReq.refundMethod === 'wallet_credit' ? 'Wallet Credit' : 
                                           returnReq.refundMethod || 'N/A' %>
                                    </small>
                                </td>
                                <td>
                                    <span class="badge 
                                        <%= returnReq.status === 'pending' ? 'bg-warning text-dark' :
                                           returnReq.status === 'approved' ? 'bg-info text-white' :
                                           returnReq.status === 'pickup_scheduled' ? 'bg-primary text-white' :
                                           returnReq.status === 'picked_up' ? 'bg-secondary text-white' :
                                           returnReq.status === 'refund_initiated' ? 'bg-purple text-white' :
                                           returnReq.status === 'refund_completed' ? 'bg-success text-white' :
                                           returnReq.status === 'rejected' ? 'bg-danger text-white' :
                                           'bg-light text-dark' %> px-3 py-2">
                                        <%= returnReq.statusText %>
                                    </span>
                                </td>
                                <td>
                                    <div class="text-dark">
                                        <%= returnReq.formattedDate %>
                                    </div>
                                    <small class="text-muted">
                                        <%= returnReq.formattedTime %>
                                    </small>
                                </td>
                                <td class="text-end pe-4">
                                    <div class="btn-group" role="group">
                                        <a href="/admin/returns/<%= returnReq._id %>" 
                                           class="btn btn-sm btn-outline-primary" 
                                           title="View & Manage">
                                            <i class="fas fa-cog"></i> Manage
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            <% }); %>
                        <% } else { %>
                            <tr>
                                <td colspan="9" class="text-center py-5">
                                    <div class="text-muted">
                                        <i class="fas fa-inbox fa-3x mb-3"></i>
                                        <h5 class="fw-bold">No Return Requests Found</h5>
                                        <p class="mb-0">
                                            <% if (statusFilter !== 'all' || methodFilter !== 'all' || searchQuery || startDate || endDate) { %>
                                                Try adjusting your search or filters
                                            <% } else { %>
                                                No return requests have been submitted yet
                                            <% } %>
                                        </p>
                                        <% if (statusFilter !== 'all' || methodFilter !== 'all' || searchQuery || startDate || endDate) { %>
                                            <button onclick="clearFilters()" class="btn btn-primary mt-3">
                                                <i class="fas fa-times me-1"></i> Clear All Filters
                                            </button>
                                        <% } %>
                                    </div>
                                </td>
                            </tr>
                        <% } %>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Pagination -->
        <% if (totalPages > 1) { %>
            <div class="card-footer bg-white py-3">
                <div class="d-flex flex-column flex-md-row justify-content-between align-items-center">
                    <div class="text-muted mb-2 mb-md-0">
                        Showing <%= ((currentPage - 1) * perPage) + 1 %> to 
                        <%= Math.min(currentPage * perPage, totalReturns) %> of 
                        <%= totalReturns %> return requests
                    </div>
                    
                    <nav aria-label="Page navigation">
                        <ul class="pagination pagination-sm mb-0">
                            <% 
                                function buildPageUrl(pageNum) {
                                    const params = new URLSearchParams();
                                    params.set('page', pageNum);
                                    if (statusFilter && statusFilter !== 'all') params.set('status', statusFilter);
                                    if (methodFilter && methodFilter !== 'all') params.set('method', methodFilter);
                                    if (searchQuery) params.set('search', searchQuery);
                                    if (sortBy !== 'newest') params.set('sort', sortBy);
                                    if (startDate) params.set('startDate', startDate);
                                    if (endDate) params.set('endDate', endDate);
                                    if (perPage !== 10) params.set('limit', perPage);
                                    return '/admin/returns?' + params.toString();
                                }
                            %>
                            
                            <!-- Previous Button -->
                            <li class="page-item <%= currentPage === 1 ? 'disabled' : '' %>">
                                <a class="page-link" 
                                   href="<%= currentPage > 1 ? buildPageUrl(currentPage - 1) : '#' %>">
                                    &laquo;
                                </a>
                            </li>

                            <!-- Page Numbers -->
                            <% 
                                let startPage = Math.max(1, currentPage - 2);
                                let endPage = Math.min(totalPages, currentPage + 2);
                                
                                if (startPage > 1) { 
                            %>
                                <li class="page-item">
                                    <a class="page-link" href="<%= buildPageUrl(1) %>">1</a>
                                </li>
                                <% if (startPage > 2) { %>
                                    <li class="page-item disabled">
                                        <span class="page-link">...</span>
                                    </li>
                                <% } %>
                            <% } %>
                            
                            <% for (let i = startPage; i <= endPage; i++) { %>
                                <li class="page-item <%= i === currentPage ? 'active' : '' %>">
                                    <a class="page-link" href="<%= buildPageUrl(i) %>">
                                        <%= i %>
                                    </a>
                                </li>
                            <% } %>
                            
                            <% if (endPage < totalPages) { %>
                                <% if (endPage < totalPages - 1) { %>
                                    <li class="page-item disabled">
                                        <span class="page-link">...</span>
                                    </li>
                                <% } %>
                                <li class="page-item">
                                    <a class="page-link" href="<%= buildPageUrl(totalPages) %>">
                                        <%= totalPages %>
                                    </a>
                                </li>
                            <% } %>

                            <!-- Next Button -->
                            <li class="page-item <%= currentPage === totalPages ? 'disabled' : '' %>">
                                <a class="page-link" 
                                   href="<%= currentPage < totalPages ? buildPageUrl(currentPage + 1) : '#' %>">
                                    &raquo;
                                </a>
                            </li>
                        </ul>
                    </nav>
                    
                    <!-- Items per page selector -->
                    <div class="mt-3 mt-md-0">
                        <select class="form-select form-select-sm" onchange="changePerPage(this.value)" style="width: auto;">
                            <option value="10" <%= perPage === 10 ? 'selected' : '' %>>10 per page</option>
                            <option value="25" <%= perPage === 25 ? 'selected' : '' %>>25 per page</option>
                            <option value="50" <%= perPage === 50 ? 'selected' : '' %>>50 per page</option>
                            <option value="100" <%= perPage === 100 ? 'selected' : '' %>>100 per page</option>
                        </select>
                    </div>
                </div>
            </div>
        <% } %>
    </div>
</div>

<!-- JavaScript Section -->
<script>
// Clear all filters
function clearFilters() {
    window.location.href = '/admin/returns';
}

// Export returns to CSV
function exportReturns() {
    // Build export URL with current filters
    let exportUrl = '/admin/returns/export';
    const params = new URLSearchParams();
    
    if ('<%= statusFilter %>' && '<%= statusFilter %>' !== 'all') {
        params.set('status', '<%= statusFilter %>');
    }
    if ('<%= methodFilter %>' && '<%= methodFilter %>' !== 'all') {
        params.set('method', '<%= methodFilter %>');
    }
    if ('<%= searchQuery %>') {
        params.set('search', '<%= searchQuery %>');
    }
    if ('<%= startDate %>') {
        params.set('startDate', '<%= startDate %>');
    }
    if ('<%= endDate %>') {
        params.set('endDate', '<%= endDate %>');
    }
    
    if (params.toString()) {
        exportUrl += '?' + params.toString();
    }
    
    window.location.href = exportUrl;
}

// Change items per page
function changePerPage(limit) {
    const url = new URL(window.location.href);
    url.searchParams.set('limit', limit);
    url.searchParams.set('page', 1); // Reset to first page
    window.location.href = url.toString();
}

// Auto-submit sort changes
document.addEventListener('DOMContentLoaded', function() {
    const sortSelect = document.querySelector('select[name="sort"]');
    const statusSelect = document.querySelector('select[name="status"]');
    const methodSelect = document.querySelector('select[name="method"]');
    
    if (sortSelect) {
        sortSelect.addEventListener('change', function() {
            document.getElementById('filterForm').submit();
        });
    }
    
    if (statusSelect) {
        statusSelect.addEventListener('change', function() {
            document.getElementById('filterForm').submit();
        });
    }
    
    if (methodSelect) {
        methodSelect.addEventListener('change', function() {
            document.getElementById('filterForm').submit();
        });
    }
    
    // Date validation
    const startDate = document.querySelector('input[name="startDate"]');
    const endDate = document.querySelector('input[name="endDate"]');
    
    if (startDate && endDate) {
        startDate.addEventListener('change', function() {
            endDate.min = this.value;
        });
        
        endDate.addEventListener('change', function() {
            startDate.max = this.value;
        });
        
        // Set initial constraints
        if (startDate.value) {
            endDate.min = startDate.value;
        }
        if (endDate.value) {
            startDate.max = endDate.value;
        }
    }
});

// Update export route function
async function exportReturns() {
    try {
        const response = await fetch('/admin/returns/export');
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `returns_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }
    } catch (error) {
        console.error('Export failed:', error);
        alert('Failed to export returns');
    }
}
</script>