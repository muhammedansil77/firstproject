<!-- views/admin/returns/returnDetail.ejs -->
<div class="container-fluid px-4">
    <!-- Back Button -->
    <div class="mb-4">
        <a href="/admin/returns" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i> Back to Returns
        </a>
    </div>

    <div class="row">
        <!-- Left Column - Return Details -->
        <div class="col-lg-8">
            <!-- Return Header -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h2 class="h4 fw-bold text-dark mb-1">
                                Return Request: REF-<%= returnReq._id.toString().slice(-8).toUpperCase() %>
                            </h2>
                            <p class="text-muted mb-0">
                                <i class="far fa-calendar me-1"></i>
                                Requested on <%= new Date(returnReq.createdAt).toLocaleDateString('en-IN', { 
                                    year: 'numeric', 
                                    month: 'long', 
                                    day: 'numeric',
                                    hour: '2-digit',
                                    minute: '2-digit'
                                }) %>
                            </p>
                        </div>
                        <div class="text-end">
                            <span class="badge 
                                <%= returnReq.status === 'pending' ? 'bg-warning text-dark' :
                                   returnReq.status === 'approved' ? 'bg-info text-white' :
                                   returnReq.status === 'pickup_scheduled' ? 'bg-primary text-white' :
                                   returnReq.status === 'picked_up' ? 'bg-secondary text-white' :
                                   returnReq.status === 'refund_initiated' ? 'bg-purple text-white' :
                                   returnReq.status === 'refund_completed' ? 'bg-success text-white' :
                                   returnReq.status === 'rejected' ? 'bg-danger text-white' :
                                   'bg-light text-dark' %> px-3 py-2 fs-6">
                                <%= returnReq.status.charAt(0).toUpperCase() + returnReq.status.slice(1).replace('_', ' ') %>
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Customer & Order Info -->
            <div class="row mb-4">
                <!-- Customer Info -->
                <div class="col-md-6">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-header bg-light">
                            <h5 class="mb-0 fw-bold"><i class="fas fa-user me-2"></i>Customer Information</h5>
                        </div>
                        <div class="card-body">
                            <table class="table table-borderless mb-0">
                                <tr>
                                    <td class="text-muted" width="40%">Name:</td>
                                    <td class="fw-bold text-dark"><%= user.fullName || 'N/A' %></td>
                                </tr>
                                <tr>
                                    <td class="text-muted">Email:</td>
                                    <td class="fw-bold text-dark"><%= user.email || 'N/A' %></td>
                                </tr>
                                <tr>
                                    <td class="text-muted">Phone:</td>
                                    <td class="fw-bold text-dark"><%= user.phone || 'N/A' %></td>
                                </tr>
                                <tr>
                                    <td class="text-muted">Customer ID:</td>
                                    <td class="fw-bold text-dark"><%= user._id.toString().slice(-8).toUpperCase() %></td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Order Info -->
                <div class="col-md-6">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-header bg-light">
                            <h5 class="mb-0 fw-bold"><i class="fas fa-shopping-cart me-2"></i>Order Information</h5>
                        </div>
                        <div class="card-body">
                            <table class="table table-borderless mb-0">
                                <tr>
                                    <td class="text-muted" width="40%">Order Number:</td>
                                    <td class="fw-bold text-dark">
                                        <a href="/admin/orders/<%= order._id %>" class="text-decoration-none">
                                            <%= order.orderNumber || 'N/A' %>
                                        </a>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="text-muted">Order Date:</td>
                                    <td class="fw-bold text-dark">
                                        <%= new Date(order.createdAt).toLocaleDateString('en-IN') %>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="text-muted">Order Status:</td>
                                    <td class="fw-bold">
                                        <span class="badge <%= 
                                            order.orderStatus === 'Delivered' ? 'bg-success' :
                                            order.orderStatus === 'Cancelled' ? 'bg-danger' :
                                            'bg-warning text-dark'
                                        %>">
                                            <%= order.orderStatus || 'N/A' %>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="text-muted">Payment Method:</td>
                                    <td class="fw-bold text-dark"><%= order.paymentMethod || 'N/A' %></td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Return Product Details -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0 fw-bold"><i class="fas fa-box me-2"></i>Product Details</h5>
                </div>
                <div class="card-body">
                  
                    <div class="row">
                        <!-- Product Image -->
                      <!-- Product Image - FIXED -->
<div class="col-md-3 mb-3">
  <img
    src="<%= item.imageSrc %>"
    alt="<%= item.product?.name || 'Product Image' %>"
    class="img-fluid rounded border"
    style="max-height:200px;object-fit:cover;width:100%;"
    onerror="this.src='https://res.cloudinary.com/lux-time/image/upload/placeholders/no-image.png'"
  >
</div>

                        
                        <!-- Product Info -->
                        <div class="col-md-9">
                            <h4 class="fw-bold text-dark mb-3"><%= item.product?.name || 'Product N/A' %></h4>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <table class="table table-borderless">
                                        <tr>
                                            <td class="text-muted" width="40%">Product ID:</td>
                                            <td class="fw-bold text-dark"><%= item.product?._id.toString().slice(-8).toUpperCase() %></td>
                                        </tr>
                                        <tr>
                                            <td class="text-muted">Quantity:</td>
                                            <td class="fw-bold text-dark"><%= item.quantity || 1 %></td>
                                        </tr>
                                        <tr>
                                            <td class="text-muted">Original Price:</td>
                                            <td class="fw-bold text-dark">â‚¹<%= (item.price || 0).toLocaleString('en-IN') %></td>
                                        </tr>
                                    </table>
                                </div>
                                <div class="col-md-6">
                                    <table class="table table-borderless">
                                        <% if (item.variant?.color) { %>
                                        <tr>
                                            <td class="text-muted">Color:</td>
                                            <td class="fw-bold text-dark">
                                                <span class="badge bg-light text-dark">
                                                    <%= item.variant.color %>
                                                </span>
                                            </td>
                                        </tr>
                                        <% } %>
                                        <% if (item.variant?.size) { %>
                                        <tr>
                                            <td class="text-muted">Size:</td>
                                            <td class="fw-bold text-dark">
                                                <span class="badge bg-light text-dark">
                                                    <%= item.variant.size %>
                                                </span>
                                            </td>
                                        </tr>
                                        <% } %>
                                        <tr>
                                            <td class="text-muted">Item Total:</td>
                                            <td class="fw-bold text-dark">â‚¹<%= (item.total || 0).toLocaleString('en-IN') %></td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Return Reason & Notes -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0 fw-bold"><i class="fas fa-comment-alt me-2"></i>Return Details</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold text-dark">Return Reason</label>
                            <div class="border rounded p-3 bg-light">
                                <%= returnReq.reason || 'No reason provided' %>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold text-dark">Refund Method</label>
                            <div class="border rounded p-3 bg-light">
                                <%= returnReq.refundMethod === 'original_method' ? 'Original Payment Method' :
                                   returnReq.refundMethod === 'bank_transfer' ? 'Bank Transfer' :
                                   returnReq.refundMethod === 'upi' ? 'UPI' :
                                   returnReq.refundMethod === 'wallet_credit' ? 'Wallet Credit' :
                                   returnReq.refundMethod || 'Not specified' %>
                            </div>
                        </div>
                    </div>
                    
                    <% if (returnReq.additionalDetails) { %>
                    <div class="mb-3">
                        <label class="form-label fw-bold text-dark">Additional Details</label>
                        <div class="border rounded p-3 bg-light">
                            <%= returnReq.additionalDetails %>
                        </div>
                    </div>
                    <% } %>

                    <!-- Return Address -->
                    <div class="mt-4">
                        <label class="form-label fw-bold text-dark">Return Pickup Address</label>
                        <div class="border rounded p-3 bg-light">
                            <p class="mb-1 fw-bold"><%= returnReq.returnAddress?.fullName || 'N/A' %></p>
                            <p class="mb-1"><%= returnReq.returnAddress?.phone || '' %></p>
                            <p class="mb-1"><%= returnReq.returnAddress?.house || '' %></p>
                            <p class="mb-1">
                                <%= returnReq.returnAddress?.city || '' %>, 
                                <%= returnReq.returnAddress?.state || '' %> 
                                <%= returnReq.returnAddress?.pincode || '' %>
                            </p>
                            <% if (returnReq.returnAddress?.landmark) { %>
                            <p class="mb-0 text-muted">Landmark: <%= returnReq.returnAddress.landmark %></p>
                            <% } %>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column - Status Management -->
        <div class="col-lg-4">
            <!-- Status Update Card -->
         <!-- Status Update Card - Simplified -->
<div class="card border-0 shadow-sm mb-4">
    <div class="card-header bg-light">
        <h5 class="mb-0 fw-bold"><i class="fas fa-exchange-alt me-2"></i>Update Return Status</h5>
    </div>
    <div class="card-body">
        <form id="statusUpdateForm">
            <input type="hidden" id="returnId" value="<%= returnReq._id %>">
            
            <!-- Current Status Display -->
            <div class="mb-3">
                <label class="form-label text-muted small">Current Status</label>
                <p class="fw-bold">
                    <span class="badge 
                        <%= returnReq.status === 'pending' ? 'bg-warning text-dark' :
                           returnReq.status === 'approved' ? 'bg-info text-white' :
                           returnReq.status === 'pickup_scheduled' ? 'bg-primary text-white' :
                           returnReq.status === 'picked_up' ? 'bg-secondary text-white' :
                           returnReq.status === 'refund_initiated' ? 'bg-purple text-white' :
                           returnReq.status === 'refund_completed' ? 'bg-success text-white' :
                           returnReq.status === 'rejected' ? 'bg-danger text-white' :
                           'bg-light text-dark' %> px-3 py-2">
                        <%= returnReq.status.charAt(0).toUpperCase() + returnReq.status.slice(1).replace('_', ' ') %>
                    </span>
                </p>
            </div>
         


            <!-- Simple Status Dropdown -->
            <div class="mb-3">
                <label class="form-label fw-bold text-dark">Update Status</label>
                <select id="newStatus" class="form-select" required>
                    <option value="">Select action...</option>
                    
                    <% 
                    const currentStatus = returnReq.status;
                    
                    // Define simple actions based on current status
                    if (currentStatus === 'pending') { %>
                        <option value="approved">âœ… Accept & Approve Return</option>
                      
                    <% } else if (currentStatus === 'approved') { %>
                        <option value="pickup_scheduled">ðŸ“… Schedule Pickup</option>
                     
                    <% } else if (currentStatus === 'pickup_scheduled') { %>
                        <option value="picked_up">ðŸ“¦ Mark as Picked Up</option>
                    <% } else if (currentStatus === 'picked_up') { %>
                        <option value="refund_initiated">ðŸ’° Initiate Refund</option>
                    <% } else if (currentStatus === 'refund_initiated') { %>
                        <option value="refund_completed">âœ… Mark Refund Completed</option>
                    <% } %>
                    
                    <!-- Always show Reject option for most statuses -->
                    <% if (['pending', 'approved', 'pickup_scheduled'].includes(currentStatus)) { %>
                      
                    <% } %>
                </select>
                <small class="text-muted">Select an action to update the return status</small>
            </div>

            <!-- Admin Notes -->
            <div class="mb-4">
                <label class="form-label fw-bold text-dark">Admin Notes</label>
                <textarea id="adminNotes" class="form-control" rows="3" 
                          placeholder="Add any notes or instructions for this status change..."></textarea>
                <small class="text-muted">Optional: These notes will be saved with the status update</small>
            </div>

            <!-- Update Button -->
            <button type="submit" class="btn btn-primary w-100">
                <i class="fas fa-save me-2"></i>Update Status
            </button>
        </form>
        
        <!-- Quick Action Buttons (Optional) -->
        <% if (returnReq.status === 'pending') { %>
        <div class="mt-3 pt-3 border-top">
            <p class="text-muted small mb-2">Quick Actions:</p>
            <div class="d-flex gap-2">
                <button type="button" class="btn btn-sm btn-success flex-fill" onclick="quickAction('approved')">
                    <i class="fas fa-check me-1"></i>Quick Accept
                </button>
                <button type="button" class="btn btn-sm btn-danger flex-fill" onclick="quickAction('rejected')">
                    <i class="fas fa-times me-1"></i>Quick Reject
                </button>
            </div>
        </div>
        <% } %>
    </div>
</div>

            <!-- Refund Amount Summary -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0 fw-bold"><i class="fas fa-money-bill-wave me-2"></i>Refund Summary</h5>
                </div>
                <div class="card-body">
                    <table class="table table-borderless mb-0">
                        <tr>
                            <td class="text-muted">Refund Amount</td>
                            <td class="text-end fw-bold text-dark fs-5">
                                â‚¹<%= (returnReq.refundAmount || 0).toLocaleString('en-IN') %>
                            </td>
                        </tr>
                        <tr>
                            <td class="text-muted">Refund Method</td>
                            <td class="text-end">
                                <%= returnReq.refundMethod === 'original_method' ? 'Original Payment' :
                                   returnReq.refundMethod === 'bank_transfer' ? 'Bank Transfer' :
                                   returnReq.refundMethod === 'upi' ? 'UPI' :
                                   returnReq.refundMethod === 'wallet_credit' ? 'Wallet Credit' :
                                   'Not specified' %>
                            </td>
                        </tr>
                        <% if (returnReq.estimatedCompletion) { %>
                        <tr>
                            <td class="text-muted">Estimated Completion</td>
                            <td class="text-end">
                                <%= new Date(returnReq.estimatedCompletion).toLocaleDateString('en-IN') %>
                            </td>
                        </tr>
                        <% } %>
                    </table>
                </div>
            </div>
            

            <!-- Timeline -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0 fw-bold"><i class="fas fa-history me-2"></i>Status Timeline</h5>
                </div>
                <div class="card-body">
                    <div class="timeline">
                        <!-- Request Submitted -->
                        <div class="timeline-item mb-3">
                            <div class="d-flex">
                                <div class="timeline-icon me-3">
                                    <i class="fas fa-paper-plane text-primary"></i>
                                </div>
                                <div>
                                    <h6 class="fw-bold mb-0 text-dark">Request Submitted</h6>
                                    <p class="text-muted mb-0 small">
                                        <%= new Date(returnReq.createdAt).toLocaleDateString('en-IN', { 
                                            day: 'numeric',
                                            month: 'short',
                                            year: 'numeric',
                                            hour: '2-digit',
                                            minute: '2-digit'
                                        }) %>
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Status-specific dates -->
                        <% if (returnReq.approvedAt) { %>
                        <div class="timeline-item mb-3">
                            <div class="d-flex">
                                <div class="timeline-icon me-3">
                                    <i class="fas fa-check-circle text-success"></i>
                                </div>
                                <div>
                                    <h6 class="fw-bold mb-0 text-dark">Approved</h6>
                                    <p class="text-muted mb-0 small">
                                        <%= new Date(returnReq.approvedAt).toLocaleDateString('en-IN', { 
                                            day: 'numeric',
                                            month: 'short',
                                            year: 'numeric',
                                            hour: '2-digit',
                                            minute: '2-digit'
                                        }) %>
                                    </p>
                                </div>
                            </div>
                        </div>
                        <% } %>

                        <% if (returnReq.pickupScheduledAt) { %>
                        <div class="timeline-item mb-3">
                            <div class="d-flex">
                                <div class="timeline-icon me-3">
                                    <i class="fas fa-calendar text-info"></i>
                                </div>
                                <div>
                                    <h6 class="fw-bold mb-0 text-dark">Pickup Scheduled</h6>
                                    <p class="text-muted mb-0 small">
                                        <%= new Date(returnReq.pickupScheduledAt).toLocaleDateString('en-IN', { 
                                            day: 'numeric',
                                            month: 'short',
                                            year: 'numeric',
                                            hour: '2-digit',
                                            minute: '2-digit'
                                        }) %>
                                    </p>
                                </div>
                            </div>
                        </div>
                        <% } %>

                        <% if (returnReq.pickedUpAt) { %>
                        <div class="timeline-item mb-3">
                            <div class="d-flex">
                                <div class="timeline-icon me-3">
                                    <i class="fas fa-truck text-secondary"></i>
                                </div>
                                <div>
                                    <h6 class="fw-bold mb-0 text-dark">Picked Up</h6>
                                    <p class="text-muted mb-0 small">
                                        <%= new Date(returnReq.pickedUpAt).toLocaleDateString('en-IN', { 
                                            day: 'numeric',
                                            month: 'short',
                                            year: 'numeric',
                                            hour: '2-digit',
                                            minute: '2-digit'
                                        }) %>
                                    </p>
                                </div>
                            </div>
                        </div>
                        <% } %>

                        <% if (returnReq.refundInitiatedAt) { %>
                        <div class="timeline-item mb-3">
                            <div class="d-flex">
                                <div class="timeline-icon me-3">
                                    <i class="fas fa-money-bill-wave text-purple"></i>
                                </div>
                                <div>
                                    <h6 class="fw-bold mb-0 text-dark">Refund Initiated</h6>
                                    <p class="text-muted mb-0 small">
                                        <%= new Date(returnReq.refundInitiatedAt).toLocaleDateString('en-IN', { 
                                            day: 'numeric',
                                            month: 'short',
                                            year: 'numeric',
                                            hour: '2-digit',
                                            minute: '2-digit'
                                        }) %>
                                    </p>
                                </div>
                            </div>
                        </div>
                        <% } %>

                        <% if (returnReq.refundCompletedAt) { %>
                        <div class="timeline-item">
                            <div class="d-flex">
                                <div class="timeline-icon me-3">
                                    <i class="fas fa-check-double text-success"></i>
                                </div>
                                <div>
                                    <h6 class="fw-bold mb-0 text-dark">Refund Completed</h6>
                                    <p class="text-muted mb-0 small">
                                        <%= new Date(returnReq.refundCompletedAt).toLocaleDateString('en-IN', { 
                                            day: 'numeric',
                                            month: 'short',
                                            year: 'numeric',
                                            hour: '2-digit',
                                            minute: '2-digit'
                                        }) %>
                                    </p>
                                </div>
                            </div>
                        </div>
                        <% } %>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
</div>


<!-- JavaScript -->
<script>
// Handle status update form submission

</script>

<style>
.timeline-item {
    position: relative;
    padding-left: 1rem;
}

.timeline-item::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 2px;
    background-color: #e9ecef;
}

.timeline-item:last-child::before {
    height: 50%;
}

.timeline-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background-color: #f8f9fa;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    z-index: 1;
}

.card {
    border: 1px solid #e0e0e0;
}

.badge {
    font-weight: 600;
    letter-spacing: 0.5px;
}
</style>